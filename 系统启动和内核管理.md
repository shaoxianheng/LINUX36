## 系统启动和内核管理

## centos7 grub2

```
[root@node1 ~]# rpm -qi grub2
Name        : grub2
Epoch       : 1
Version     : 2.02
Release     : 0.64.el7.centos
Architecture: x86_64
Install Date: Thu 27 Aug 2020 09:06:14 PM CST
Group       : System Environment/Base
Size        : 0
License     : GPLv3+
Signature   : RSA/SHA256, Wed 23 Aug 2017 01:17:59 AM CST, Key ID 24c6a8a7f4a80eb5
Source RPM  : grub2-2.02-0.64.el7.centos.src.rpm
Build Date  : Fri 18 Aug 2017 02:01:13 AM CST
Build Host  : kbuilder.dev.centos.org
Relocations : (not relocatable)
Packager    : CentOS BuildSystem <http://bugs.centos.org>
Vendor      : CentOS
URL         : http://www.gnu.org/software/grub/
Summary     : Bootloader with support for Linux, Multiboot and more
Description :

The GRand Unified Bootloader (GRUB) is a highly configurable and
customizable bootloader with modular architecture.  It supports a rich
variety of kernel formats, file systems, computer architectures and
hardware devices.

```

```
[root@node1 ~]# hexdump -C -n 512 /dev/sda
00000000  eb 63 90 10 8e d0 bc 00  b0 b8 00 00 8e d8 8e c0  |.c..............|
00000010  fb be 00 7c bf 00 06 b9  00 02 f3 a4 ea 21 06 00  |...|.........!..|
00000020  00 be be 07 38 04 75 0b  83 c6 10 81 fe fe 07 75  |....8.u........u|
00000030  f3 eb 16 b4 02 b0 01 bb  00 7c b2 80 8a 74 01 8b  |.........|...t..|
00000040  4c 02 cd 13 ea 00 7c 00  00 eb fe 00 00 00 00 00  |L.....|.........|
00000050  00 00 00 00 00 00 00 00  00 00 00 80 01 00 00 00  |................|
00000060  00 00 00 00 ff fa 90 90  f6 c2 80 74 05 f6 c2 70  |...........t...p|
00000070  74 02 b2 80 ea 79 7c 00  00 31 c0 8e d8 8e d0 bc  |t....y|..1......|
00000080  00 20 fb a0 64 7c 3c ff  74 02 88 c2 52 be 05 7c  |. ..d|<.t...R..||
00000090  b4 41 bb aa 55 cd 13 5a  52 72 3d 81 fb 55 aa 75  |.A..U..ZRr=..U.u|
000000a0  37 83 e1 01 74 32 31 c0  89 44 04 40 88 44 ff 89  |7...t21..D.@.D..|
000000b0  44 02 c7 04 10 00 66 8b  1e 5c 7c 66 89 5c 08 66  |D.....f..\|f.\.f|
000000c0  8b 1e 60 7c 66 89 5c 0c  c7 44 06 00 70 b4 42 cd  |..`|f.\..D..p.B.|
000000d0  13 72 05 bb 00 70 eb 76  b4 08 cd 13 73 0d 5a 84  |.r...p.v....s.Z.|
000000e0  d2 0f 83 de 00 be 85 7d  e9 82 00 66 0f b6 c6 88  |.......}...f....|
000000f0  64 ff 40 66 89 44 04 0f  b6 d1 c1 e2 02 88 e8 88  |d.@f.D..........|
00000100  f4 40 89 44 08 0f b6 c2  c0 e8 02 66 89 04 66 a1  |.@.D.......f..f.|
00000110  60 7c 66 09 c0 75 4e 66  a1 5c 7c 66 31 d2 66 f7  |`|f..uNf.\|f1.f.|
00000120  34 88 d1 31 d2 66 f7 74  04 3b 44 08 7d 37 fe c1  |4..1.f.t.;D.}7..|
00000130  88 c5 30 c0 c1 e8 02 08  c1 88 d0 5a 88 c6 bb 00  |..0........Z....|
00000140  70 8e c3 31 db b8 01 02  cd 13 72 1e 8c c3 60 1e  |p..1......r...`.|
00000150  b9 00 01 8e db 31 f6 bf  00 80 8e c6 fc f3 a5 1f  |.....1..........|
00000160  61 ff 26 5a 7c be 80 7d  eb 03 be 8f 7d e8 34 00  |a.&Z|..}....}.4.|
00000170  be 94 7d e8 2e 00 cd 18  eb fe 47 52 55 42 20 00  |..}.......GRUB .|
00000180  47 65 6f 6d 00 48 61 72  64 20 44 69 73 6b 00 52  |Geom.Hard Disk.R|
00000190  65 61 64 00 20 45 72 72  6f 72 0d 0a 00 bb 01 00  |ead. Error......|
000001a0  b4 0e cd 10 ac 3c 00 75  f4 c3 00 00 00 00 00 00  |.....<.u........|
000001b0  00 00 00 00 00 00 00 00  2d 9d 03 00 00 00 80 20  |........-...... |
000001c0  21 00 83 aa 28 82 00 08  00 00 00 00 20 00 00 aa  |!...(....... ...|
000001d0  29 82 8e fe ff ff 00 08  20 00 00 f8 5f 02 00 00  |)....... ..._...|
000001e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200

```



## 驱动文件

```
[root@node1 ~]# locate ext4.ko
/usr/lib/modules/3.10.0-693.el7.x86_64/kernel/fs/ext4/ext4.ko.xz
[root@node1 ~]# locate ext3.ko
[root@node1 ~]# locate xfs.ko
/usr/lib/modules/3.10.0-693.el7.x86_64/kernel/fs/xfs/xfs.ko.xz

```

```
[root@node1 ~]# lsmod |grep xfs
xfs                   978100  2 
libcrc32c              12644  3 xfs,nf_nat,nf_conntrack
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# file /boot/vmlinuz-3.10.0-693.el7.x86_64 
/boot/vmlinuz-3.10.0-693.el7.x86_64: Linux kernel x86 boot executable bzImage, version 3.10.0-693.el7.x86_64 (builder@kbuilder.dev.centos.org) #1 
SMP , RO-rootFS, swap_dev 0x5, Normal VGA[root@node1 ~]# 

```

## 删除centos6的内核文件

![image-20201018144447484](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018144447484.png)

```
[root@bogon ~]# rm -rf /boot/vmlinuz-2.6.32-573.el6.x86_64 
[root@bogon ~]# reboot

Broadcast message from root@bogon
	(/dev/pts/0) at 9:09 ...

The system is going down for reboot NOW!

```

开始光盘救援模式

![image-20201018144714215](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018144714215.png)

![image-20201018145841481](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018145841481.png)

![image-20201018150138254](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018150138254.png)

## initramfs

```
[root@bogon ~]# ll /boot/
total 38431
-rw-r--r--. 1 root root   107134 Jul 24  2015 config-2.6.32-573.el6.x86_64
drwxr-xr-x. 3 root root     1024 Sep 28 21:41 efi
drwxr-xr-x. 2 root root     1024 Sep 28 21:43 grub
-rw-------. 1 root root 27987736 Sep 28 21:43 initramfs-2.6.32-573.el6.x86_64.img
drwx------. 2 root root    12288 Sep 28 21:37 lost+found
-rw-r--r--. 1 root root   205998 Jul 24  2015 symvers-2.6.32-573.el6.x86_64.gz
-rw-r--r--. 1 root root  2585052 Jul 24  2015 System.map-2.6.32-573.el6.x86_64
-r-xr-xr-x. 1 root root  4220560 Oct 14 09:23 vmlinuz-
-r-xr-xr-x. 1 root root  4220560 Oct 14 09:23 vmlinuz-2.6.32-573.el6.x86_64

```

## 打开initramfs文件

```
  110  cp /boot/initramfs-2.6.32-573.el6.x86_64.img .
  111  mv initramfs-2.6.32-573.el6.x86_64.img initramfs-2.6.32-573.el6.x86_64.img.gz
  112  gunzip initramfs-2.6.32-573.el6.x86_64.img.gz
  113  file initramfs-2.6.32-573.el6.x86_64.img 
  114  cpio -it < initramfs-2.6.32-573.el6.x86_64.img

```

## 存在根的驱动

```
[root@bogon ~]# cpio -it < initramfs-2.6.32-573.el6.x86_64.img |grep ext
usr/share/plymouth/themes/text
usr/share/plymouth/themes/text/text.plymouth
usr/lib64/plymouth/text.so
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext3
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext3/ext3.ko
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext2
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext2/ext2.ko
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4
lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko
lib/kbd/keymaps/i386/include/linux-keys-extd.inc
163551 blocks

```

## 删除initramfs，相当于不能挂载根

```
[root@bogon ~]# rm -rf /boot/initramfs-2.6.32-573.el6.x86_64.img 
reboot

```

![image-20201018151720432](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018151720432.png)

![image-20201018153600737](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018153600737.png)

```
chroot /mnt/sysimage  切换到真正的系统
mkinitrd /boot/initramfs-`uname -r`.img `uname-r`  名字-- 和参数
exit  退出
reboot
```

## 启动init的区别6和7

```
[root@bogon ~]# rpm -qf /sbin/init
upstart-0.6.5-13.el6_5.3.x86_64
[root@bogon ~]# rpm -qi upstart
Name        : upstart                      Relocations: (not relocatable)
Version     : 0.6.5                             Vendor: CentOS
Release     : 13.el6_5.3                    Build Date: Wed 12 Mar 2014 07:06:08 PM CST
Install Date: Mon 28 Sep 2020 09:38:27 PM CST      Build Host: c6b8.bsys.dev.centos.org
Group       : System Environment/Base       Source RPM: upstart-0.6.5-13.el6_5.3.src.rpm
Size        : 563633                           License: GPLv2 and LGPLv2+
Signature   : RSA/SHA1, Thu 13 Mar 2014 12:29:41 AM CST, Key ID 0946fca2c105b9de
Packager    : CentOS BuildSystem <http://bugs.centos.org>
URL         : http://upstart.ubuntu.com
Summary     : An event-driven init system
Description :
Upstart is an event-based replacement for the /sbin/init daemon which
handles starting of tasks and services during boot, stopping them
during shutdown and supervising them while the system is running.
[root@bogon ~]# 

```

```
[root@node1 boot]# rpm -qf /sbin/init 
systemd-219-42.el7.x86_64
[root@node1 boot]# rpm -qi systemd
Name        : systemd
Version     : 219
Release     : 42.el7
Architecture: x86_64
Install Date: Thu 27 Aug 2020 08:57:23 PM CST
Group       : Unspecified
Size        : 22001263
License     : LGPLv2+ and MIT and GPLv2+
Signature   : RSA/SHA256, Fri 11 Aug 2017 04:00:28 AM CST, Key ID 24c6a8a7f4a80eb5
Source RPM  : systemd-219-42.el7.src.rpm
Build Date  : Sat 05 Aug 2017 02:38:39 PM CST
Build Host  : c1bm.rdu2.centos.org
Relocations : (not relocatable)
Packager    : CentOS BuildSystem <http://bugs.centos.org>
Vendor      : CentOS
URL         : http://www.freedesktop.org/wiki/Software/systemd
Summary     : A System and Service Manager

```

```
[root@bogon ~]# file /sbin/init
/sbin/init: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked (uses sh
ared libs), for GNU/Linux 2.6.18, stripped[root@bogon ~]#  cat /etc/inittab 
# inittab is only used by upstart for the default runlevel.
#
# ADDING OTHER CONFIGURATION HERE WILL HAVE NO EFFECT ON YOUR SYSTEM.
#
# System initialization is started by /etc/init/rcS.conf
#
# Individual runlevels are started by /etc/init/rc.conf
#
# Ctrl-Alt-Delete is handled by /etc/init/control-alt-delete.conf
#

```

## 6启动字符界面

```
[root@bogon ~]# grep initdefault /etc/inittab
#   0 - halt (Do NOT set initdefault to this)
#   6 - reboot (Do NOT set initdefault to this)
id:3:initdefault:
[root@bogon ~]# 

```

## 切换模式

```
[root@bogon ~]# init 5
[root@bogon ~]# runlevel 
3 5
[root@bogon ~]# 

```

## 可以从启动中选择模式：输入a

![image-20201018191330857](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018191330857.png)

## 1 模式单用户模式，断网

![image-20201018191737697](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018191737697.png)

## centos 6 破解口令 ；输入a

![image-20201018192040445](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018192040445.png)

## 初始化脚本

```
[root@bogon ~]# cat /etc/rc.d/rc.sysinit

```

```
[root@bogon rc3.d]# ./S90crond 
Usage: ./S90crond {start|stop|status|restart|condrestart|try-restart|reload|force-reload}
[root@bogon rc3.d]# ./S90crond start
[root@bogon rc3.d]# 

```

## 开机修改atd为停止

```
[root@bogon rc3.d]# init 5
[root@bogon rc3.d]# cd ../rc5.d/
[root@bogon rc5.d]# ls
K01smartd        K50kdump       K76ypbind          K95rdma          S11portreserve     S24nfslock           S28autofs          S95atd
K02oddjobd       K60nfs         K84wpa_supplicant  K99rngd          S12rsyslog         S24rpcgssd           S50bluetooth       S99certmonger
K05wdaemon       K61nfs-rdma    K87restorecond     S01sysstat       S13cpuspeed        S25blk-availability  S55sshd            S99local
K10psacct        K69rpcsvcgssd  K88sssd            S02lvm2-monitor  S13irqbalance      S25cups              S70spice-vdagentd
K10saslauthd     K73winbind     K89netconsole      S08ip6tables     S13rpcbind         S25netfs             S80postfix
K15htcacheclean  K74ntpd        K89rdisc           S08iptables      S15mdmonitor       S26acpid             S82abrt-ccpp
K15httpd         K75ntpdate     K92pppoe-server    S10network       S22messagebus      S26haldaemon         S82abrtd
K50dnsmasq       K75quota_nld   K95firstboot       S11auditd        S23NetworkManager  S26udev-post         S90crond
[root@bogon rc5.d]# service
service      serviceconf  
[root@bogon rc5.d]# service atd status
atd (pid  2129) is running...
[root@bogon rc5.d]# ntsysv atd

```

## 把3模式修改为和5模式一样crond 为停止

```
[root@bogon rc5.d]# ntsysv 
[root@bogon rc5.d]# ntsysv --level=3
[root@bogon rc5.d]# ntsysv 
[root@bogon rc5.d]# ntsysv --level=3
[root@bogon rc5.d]# ls K*crond
K60crond
[root@bogon rc5.d]# reboot
[root@bogon ~]# runlevel 
N 3
[root@bogon ~]# service crond status
crond is stopped
[root@bogon ~]# 


```

## 列出各个模式启动情况

```
[root@bogon ~]# chkconfig --list
[root@bogon ~]# chkconfig --list |grep crond
crond          	0:off	1:off	2:on	3:off	4:on	5:off	6:off
[root@bogon ~]# chkconfig --list atd
atd            	0:off	1:off	2:off	3:off	4:on	5:on	6:off
[root@bogon ~]# chkconfig --list crond
crond          	0:off	1:off	2:on	3:off	4:on	5:off	6:off
[root@bogon ~]# chkconfig --level 35 crond on
[root@bogon ~]# chkconfig --list crond
crond          	0:off	1:off	2:on	3:on	4:on	5:on	6:off
[root@bogon ~]# 


```

```
[root@bogon ~]# chkconfig --level 345 crond off
[root@bogon ~]# chkconfig --list crond
crond          	0:off	1:off	2:on	3:off	4:off	5:off	6:off
[root@bogon ~]# chkconfig --level 2345 crond off
[root@bogon ~]# chkconfig --list crond
crond          	0:off	1:off	2:off	3:off	4:off	5:off	6:off

[root@bogon ~]# chkconfig  crond on
[root@bogon ~]# chkconfig --list crond
crond          	0:off	1:off	2:on	3:on	4:on	5:on	6:off

```

##  定义一个测试服务脚本

```
[root@bogon init.d]# cat testsrv 
#!/bin/bash
#
# chkconfig: - 97 3
# description: test service
. /etc/init.d/functions
start () {
      touch /var/lock/subsys/`basename $0`
      action "starting`basename $0`"
}
stop () {
      rm -f /var/lock/subsys/`basename $0`
      action "stopping`basename $0`"

}
status () {

      [ -f /var/lock/subsys/`basename $0` ] && echo `basename $0` is running || echo `basename $0` is stopped
}

case $1 in
start)
     start
     ;;
stop)
     stop
     ;;
restart)
     stop
     start
     ;;
status)
     status
     ;;
*)
    echo "Usage: /etc/init.d/`basename $0` {start|stop|status|restart}"
esac
[root@bogon init.d]# 

```

## 加入服务列表

```
[root@bogon init.d]# chkconfig --add testsrv
[root@bogon init.d]# ll /etc/rc.d/rc*.d/*testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc0.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc1.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc2.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc3.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc4.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc5.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc6.d/K03testsrv -> ../init.d/testsrv
[root@bogon init.d]# 

```

## 加入开机自启动

```
[root@bogon init.d]# chkconfig --level 35 testsrv on
[root@bogon init.d]# ll /etc/rc.d/rc*.d/*testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc0.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc1.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc2.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:42 /etc/rc.d/rc3.d/S97testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc4.d/K03testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:42 /etc/rc.d/rc5.d/S97testsrv -> ../init.d/testsrv
lrwxrwxrwx. 1 root root 17 Oct 14 15:38 /etc/rc.d/rc6.d/K03testsrv -> ../init.d/testsrv
[root@bogon init.d]# 
[root@bogon init.d]# chkconfig --list testsrv
testsrv        	0:off	1:off	2:off	3:on	4:off	5:on	6:off
[root@bogon init.d]# reboot


```

## 模拟启动脚本睡眠1000秒

```
[root@bogon init.d]# cat testsrv 
#!/bin/bash
#
# chkconfig: - 97 3
# description: test service
. /etc/init.d/functions
start () {
      touch /var/lock/subsys/testsrv
      action "starting testsrv"
      sleep 1000
}
stop () {
      rm -f /var/lock/subsys/testsrv
      action "stopping testsrv"

}
status () {

      [ -f /var/lock/subsys/testsrv ] && echo testsrv is running || echo testsrv is stopped
}

case $1 in
start)
     start
     ;;
stop)
     stop
     ;;
restart)
     stop
     start
     ;;
status)
     status
     ;;
*)
    echo "Usage: /etc/init.d/testsrv {start|stop|status|restart}"
esac

```

![image-20201018213053208](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018213053208.png)

## 进入单用户模式1

![image-20201018213146547](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018213146547.png)

![image-20201018213323708](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201018213323708.png)

## 安装telnet-server软件包

```

yum -y install telnet-server
xinetd based services:
	chargen-dgram: 	off
	chargen-stream:	off
	daytime-dgram: 	off
	daytime-stream:	off
	discard-dgram: 	off
	discard-stream:	off
	echo-dgram:    	off
	echo-stream:   	off
	rsync:         	off
	tcpmux-server: 	off
	telnet:        	off
	time-dgram:    	off
	time-stream:   	off
[root@bogon ~]# chkconfig --list 

```

##  修改配置文件

```
[root@bogon ~]# service xinetd status
xinetd is stopped
[root@bogon ~]# vi /etc/xinetd.d/telnet 
	disable		= no

```

状态

```
xinetd based services:
	chargen-dgram: 	off
	chargen-stream:	off
	daytime-dgram: 	off
	daytime-stream:	off
	discard-dgram: 	off
	discard-stream:	off
	echo-dgram:    	off
	echo-stream:   	off
	rsync:         	off
	tcpmux-server: 	off
	telnet:        	on
	time-dgram:    	off
	time-stream:   	off
[root@bogon ~]# chkconfig --list 

```

## 命令修改状态

```
xinetd based services:
	chargen-dgram: 	off
	chargen-stream:	off
	daytime-dgram: 	off
	daytime-stream:	off
	discard-dgram: 	off
	discard-stream:	off
	echo-dgram:    	off
	echo-stream:   	off
	rsync:         	off
	tcpmux-server: 	off
	telnet:        	off
	time-dgram:    	off
	time-stream:   	off
[root@bogon ~]# chkconfig telnet off

[root@bogon ~]# chkconfig telnet on

```

## 启动telnet服务

```
[root@bogon ~]# service xinetd start
Starting xinetd:                                           [  OK  ]
[root@bogon ~]# ss -tnl
State       Recv-Q Send-Q                                        Local Address:Port                                          Peer Address:Port 
LISTEN      0      128                                                      :::111                                                     :::*     
LISTEN      0      128                                                       *:111                                                      *:*     
LISTEN      0      128                                                      :::22                                                      :::*     
LISTEN      0      128                                                       *:22                                                       *:*     
LISTEN      0      64                                                       :::23                                                      :::*     
LISTEN      0      128                                               127.0.0.1:631                                                      *:*     
LISTEN      0      128                                                     ::1:631                                                     :::*     
LISTEN      0      128                                                      :::43799                                                   :::*     
LISTEN      0      100                                                     ::1:25                                                      :::*     
LISTEN      0      100                                               127.0.0.1:25                                                       *:*     
LISTEN      0      128                                               127.0.0.1:6010                                                     *:*     
LISTEN      0      128                                                     ::1:6010                                                    :::*     
LISTEN      0      128                                                       *:39258       
```

## xinetd进程监听23端口

```
[root@bogon ~]# lsof -i :23
COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
xinetd  2447 root    5u  IPv6  17083      0t0  TCP *:telnet (LISTEN)
[root@bogon ~]# 

```

```
[root@bogon ~]# ps aux |grep xinetd
root       2447  0.0  0.0  21716   984 ?        Ss   16:51   0:00 xinetd -stayalive -pidfile /var/run/xinetd.pid
root       2462  0.0  0.0 103308   852 pts/0    S+   16:54   0:00 grep xinetd
[root@bogon ~]# 

```

## 如果又主机telnet 此主机，那么telnet进程就会被激活

```
[root@bogon ~]# ps aux |grep xinetd
root       2447  0.0  0.0  21716   984 ?        Ss   16:51   0:00 xinetd -stayalive -pidfile /var/run/xinetd.pid
root       2462  0.0  0.0 103308   852 pts/0    S+   16:54   0:00 grep xinetd
[root@bogon ~]# 
[root@bogon ~]# ss -tnlpa

```

## centos7 systemd 一统江湖

启动脚步配置文件

```
root@bogon ~]# ll /etc/rc.d/rc*.d/*local
lrwxrwxrwx. 1 root root 11 Sep 28 21:39 /etc/rc.d/rc2.d/S99local -> ../rc.local
lrwxrwxrwx. 1 root root 11 Sep 28 21:39 /etc/rc.d/rc3.d/S99local -> ../rc.local
lrwxrwxrwx. 1 root root 11 Sep 28 21:39 /etc/rc.d/rc4.d/S99local -> ../rc.local
lrwxrwxrwx. 1 root root 11 Sep 28 21:39 /etc/rc.d/rc5.d/S99local -> ../rc.local
[root@bogon ~]# 

```

## Centos 7 想要启动运行脚本要加上执行权限

```
[root@centos7 ~]# ll /etc/rc.d/rc.local 
-rw-r--r--. 1 root root 473 Aug  5  2017 /etc/rc.d/rc.local
[root@centos7 ~]# 
[root@centos7 ~]# 
[root@centos7 ~]# chmod +x /etc/rc.d/rc.local
[root@centos7 ~]# ll /etc/rc.d/rc.local
-rwxr-xr-x. 1 root root 473 Aug  5  2017 /etc/rc.d/rc.local
[root@centos7 ~]# 

```

## centos6  /etc/inittab  三键重启 ctrl +alt + ins

![image-20201022214137500](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201022214137500.png)

想重启，可以在字符界面，会自动重启，或者虚拟编辑发送重启

```
[root@centos6 etc]# cat /etc/init/control-alt-delete.conf
# control-alt-delete - emergency keypress handling
#
# This task is run whenever the Control-Alt-Delete key combination is
# pressed.  Usually used to shut down the machine.
#
# Do not edit this file directly. If you want to change the behaviour,
# please create a file control-alt-delete.override and put your changes there.

start on control-alt-delete

exec /sbin/shutdown -r now "Control-Alt-Delete pressed"  注释这一行，就不能重启。

```

实验：编译httpd并使用脚本启动

总结：系统的启动流程

## centos7 编译安装httpd

```
[root@node1 ~]# cat apa.sh 
#!/bin/bash
tar xf httpd-2.4.25.tar.bz2 -C /usr/local/
cd /usr/local/
cd httpd-2.4.25/
yum -y install apr apr-util
yum -y install apr apr-util-devel
yum -y install gcc
yum -y install pcre pcre-devel
./configure 
make && make install
/usr/local/apache2/bin/apachectl 
ss -tnl
curl localhost


```

## centos6 编译安装httpd 

```
cat >apache.sh<<EOF
#!/bin/bash
#
yum -y  groupinstall "Developent Tools" "Server Platform Developemnt"
tar xf apr-1.5.0.tar.bz2 
cd apr-1.5.0
./configure --prefix=/usr/local/apr
make && make install
cd ~
tar xf apr-util-1.5.3.tar.bz2 
cd apr-util-1.5.3
./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/
make && make install
cd ~
tar xf httpd-2.2.29.tar.bz2 
cd httpd-2.2.29
groupadd -r apache
useradd -r -g apache apache
./configure --prefix=/usr/local/apache --sysconf=/etc/httpd24 --enable-so --enable-ssl --enable-cgi --enable-rewite --with-zile --with-pcre \
--with-apr=/usr/local/apr --with-apr-util=/usr/local/apr-util --enable-modules=most --enable-mpms-shared=all --with-mpm=prefork 
make && make install
sed  -i '/#ServerName/s/^#//g' /etc/httpd24/httpd.conf
/usr/local/apache/bin/apachectl start
curl localhost
EOF
```

服务脚本（centos7也适用）

```
cat >/etc/init.d/apache<<EOF
#!/bin/bash
#
# chkconfig: - 97 3
# description: apache server
. /etc/init.d/functions
start () {
      touch /var/lock/subsys/`basename $0`
      action "starting  `basename $0`"
}
stop () {
      rm -f /var/lock/subsys/`basename $0`
      action "stopping  `basename $0`"

}
status () {

      [ -f /var/lock/subsys/`basename $0` ] && echo `basename $0` is running || echo `basename $0` is stopped
}

case $1 in
start)
     start
     ;;
stop)
     stop
     ;;
restart)
     stop
     start
     ;;
status)
     status
     ;;
*)
    echo "Usage: /etc/init.d/`basename $0` {start|stop|status|restart}"
esac
EOF
```

```
cd /etc/init.d/
chmod +x /etc/init.d/apache
chkconfig --list
chkconfig --level 35 apache on
chkconfig --list
ls /var/lock/subsys/
service apache start
ll /var/lock/subsys/

```

## grub 1阶段

```
[root@bogon boot]# modinfo ext4
filename:       /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko
license:        GPL
description:    Fourth Extended Filesystem
author:         Remy Card, Stephen Tweedie, Andrew Morton, Andreas Dilger, Theodore Ts'o and others
srcversion:     CB1B990F5A758DFB0FB12F1
depends:        mbcache,jbd2
vermagic:       2.6.32-573.el6.x86_64 SMP mod_unload modversions 
[root@bogon boot]# ll /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko 
-rwxr--r--. 1 root root 643472 Jul 24  2015 /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko
[root@bogon boot]# ll /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko -h
-rwxr--r--. 1 root root 629K Jul 24  2015 /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/ext4/ext4.ko

```

```
[root@bogon boot]# ls /boot/
config-2.6.32-573.el6.x86_64  grub                                 lost+found                        System.map-2.6.32-573.el6.x86_64
efi                           initramfs-2.6.32-573.el6.x86_64.img  symvers-2.6.32-573.el6.x86_64.gz  vmlinuz-2.6.32-573.el6.x86_64
[root@bogon boot]# cd /boot/grub/
[root@bogon grub]# ls
device.map     fat_stage1_5  grub.conf         jfs_stage1_5  minix_stage1_5     splash.xpm.gz  stage2         vstafs_stage1_5
e2fs_stage1_5  ffs_stage1_5  iso9660_stage1_5  menu.lst      reiserfs_stage1_5  stage1         ufs2_stage1_5  xfs_stage1_5
[root@bogon grub]# 
[root@bogon grub]# cat grub.conf 
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=0
timeout=5
splashimage=(hd0,0)/grub/splash.xpm.gz
hiddenmenu
title CentOS 6 (2.6.32-573.el6.x86_64)
	root (hd0,0)
	kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root nomodeset rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGr
oup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet	initrd /initramfs-2.6.32-573.el6.x86_64.img

```

## 增加一个启动菜单

```
[root@bogon ~]# cat /boot/grub/grub.conf
# grub.conf generated by anaconda
#
# Note that you do not have to rerun grub after making changes to this file
# NOTICE:  You have a /boot partition.  This means that
#          all kernel and initrd paths are relative to /boot/, eg.
#          root (hd0,0)
#          kernel /vmlinuz-version ro root=/dev/mapper/VolGroup-lv_root
#          initrd /initrd-[generic-]version.img
#boot=/dev/sda
default=1
timeout=50
splashimage=(hd0,0)/grub/splash.xpm.gz
#hiddenmenu
title CentOS 6 (2.6.32-573.el6.x86_64)
	root (hd0,0)
	kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root nomodeset rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGr
oup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet	initrd /initramfs-2.6.32-573.el6.x86_64.img
title CentOS 6 (test)
	root (hd0,0)
	kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root nomodeset rd_NO_LUKS LANG=en_US.UTF-8 rd_NO_MD rd_LVM_LV=VolGr
oup/lv_swap SYSFONT=latarcyrheb-sun16 crashkernel=auto rd_LVM_LV=VolGroup/lv_root  KEYBOARDTYPE=pc KEYTABLE=us rd_NO_DM rhgb quiet	initrd /initramfs-2.6.32-573.el6.x86_64.img

```

## 破坏bootload 446个字节

```
[root@bogon ~]# hexdump -C /dev/sda -n 512
00000000  eb 48 90 10 8e d0 bc 00  b0 b8 00 00 8e d8 8e c0  |.H..............|
00000010  fb be 00 7c bf 00 06 b9  00 02 f3 a4 ea 21 06 00  |...|.........!..|
00000020  00 be be 07 38 04 75 0b  83 c6 10 81 fe fe 07 75  |....8.u........u|
00000030  f3 eb 16 b4 02 b0 01 bb  00 7c b2 80 8a 74 03 02  |.........|...t..|
00000040  80 00 00 80 fe 49 08 00  00 08 fa 90 90 f6 c2 80  |.....I..........|
00000050  75 02 b2 80 ea 59 7c 00  00 31 c0 8e d8 8e d0 bc  |u....Y|..1......|
00000060  00 20 fb a0 40 7c 3c ff  74 02 88 c2 52 f6 c2 80  |. ..@|<.t...R...|
00000070  74 54 b4 41 bb aa 55 cd  13 5a 52 72 49 81 fb 55  |tT.A..U..ZRrI..U|
00000080  aa 75 43 a0 41 7c 84 c0  75 05 83 e1 01 74 37 66  |.uC.A|..u....t7f|
00000090  8b 4c 10 be 05 7c c6 44  ff 01 66 8b 1e 44 7c c7  |.L...|.D..f..D|.|
000000a0  04 10 00 c7 44 02 01 00  66 89 5c 08 c7 44 06 00  |....D...f.\..D..|
000000b0  70 66 31 c0 89 44 04 66  89 44 0c b4 42 cd 13 72  |pf1..D.f.D..B..r|
000000c0  05 bb 00 70 eb 7d b4 08  cd 13 73 0a f6 c2 80 0f  |...p.}....s.....|
000000d0  84 f0 00 e9 8d 00 be 05  7c c6 44 ff 00 66 31 c0  |........|.D..f1.|
000000e0  88 f0 40 66 89 44 04 31  d2 88 ca c1 e2 02 88 e8  |..@f.D.1........|
000000f0  88 f4 40 89 44 08 31 c0  88 d0 c0 e8 02 66 89 04  |..@.D.1......f..|
00000100  66 a1 44 7c 66 31 d2 66  f7 34 88 54 0a 66 31 d2  |f.D|f1.f.4.T.f1.|
00000110  66 f7 74 04 88 54 0b 89  44 0c 3b 44 08 7d 3c 8a  |f.t..T..D.;D.}<.|
00000120  54 0d c0 e2 06 8a 4c 0a  fe c1 08 d1 8a 6c 0c 5a  |T.....L......l.Z|
00000130  8a 74 0b bb 00 70 8e c3  31 db b8 01 02 cd 13 72  |.t...p..1......r|
00000140  2a 8c c3 8e 06 48 7c 60  1e b9 00 01 8e db 31 f6  |*....H|`......1.|
00000150  31 ff fc f3 a5 1f 61 ff  26 42 7c be 7f 7d e8 40  |1.....a.&B|..}.@|
00000160  00 eb 0e be 84 7d e8 38  00 eb 06 be 8e 7d e8 30  |.....}.8.....}.0|
00000170  00 be 93 7d e8 2a 00 eb  fe 47 52 55 42 20 00 47  |...}.*...GRUB .G|
00000180  65 6f 6d 00 48 61 72 64  20 44 69 73 6b 00 52 65  |eom.Hard Disk.Re|
00000190  61 64 00 20 45 72 72 6f  72 00 bb 01 00 b4 0e cd  |ad. Error.......|
000001a0  10 ac 3c 00 75 f4 c3 00  00 00 00 00 00 00 00 00  |..<.u...........|
000001b0  00 00 00 00 00 00 00 00  62 ce 0b 00 00 00 80 20  |........b...... |
000001c0  21 00 83 dd 1e 3f 00 08  00 00 00 a0 0f 00 00 dd  |!....?..........|
000001d0  1f 3f 8e fe ff ff 00 a8  0f 00 00 58 70 02 00 00  |.?.........Xp...|
000001e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa  |..............U.|
00000200

```

```
[root@bogon ~]# dd if=/dev/zero of=/dev/sda bs=1 count=446
446+0 records in
446+0 records out
446 bytes (446 B) copied, 0.0117783 s, 37.9 kB/s
[root@bogon ~]# reboot


 hexdump -C /dev/sda -n 512
```

## 恢复bootload方法1

```
选择修复系统
进入start shell
#grub
grub> root (hd0,0)
grub> setup (hd0)
grub> quit
#reboot
需要重启2次
这种方法，/boot/grub/目录下的文件不能又丢失，
```

## 在此模拟删除bootload和grub下面的文件

```
[root@bogon grub]# mkdir /data
[root@bogon grub]# ls
device.map     fat_stage1_5  grub.conf         jfs_stage1_5  minix_stage1_5     splash.xpm.gz  stage2         vstafs_stage1_5
e2fs_stage1_5  ffs_stage1_5  iso9660_stage1_5  menu.lst      reiserfs_stage1_5  stage1         ufs2_stage1_5  xfs_stage1_5
[root@bogon grub]# mv * /data/
[root@bogon grub]# ls
[root@bogon grub]# dd if=/dev/zero of=/dev/sda bs=1 count=446
446+0 records in
446+0 records out
446 bytes (446 B) copied, 0.010357 s, 43.1 kB/s
[root@bogon grub]# 

```

## 在使用grub命令修复不行

```
[root@bogon grub]# grub
Probing devices to guess BIOS drives. This may take a long time.


    GNU GRUB  version 0.97  (640K lower / 3072K upper memory)

 [ Minimal BASH-like line editing is supported.  For the first word, TAB
   lists possible command completions.  Anywhere else TAB lists the possible
   completions of a device/filename.]
grub> root (hd0,0)
root (hd0,0)
 Filesystem type is ext2fs, partition type 0x83
grub> setup (hd0)
setup (hd0)
 Checking if "/boot/grub/stage1" exists... no
 Checking if "/grub/stage1" exists... no

Error 15t: File not found
grub> 

```

## 直接使用grub-install 命令恢复

```
[root@bogon grub]# grub-install /dev/sda
Probing devices to guess BIOS drives. This may take a long time.
Installation finished. No error reported.
This is the contents of the device map /boot/grub/device.map.
Check if this is correct or not. If any of the lines is incorrect,
fix it and re-run the script `grub-install'.

(fd0)	/dev/fd0
(hd0)	/dev/sda
[root@bogon grub]# 

```

## 模拟破坏1.5阶段

```
[root@bogon grub]# dd if=/dev/zero of=/dev/sda bs=1 count=10240 seek=512
10240+0 records in
10240+0 records out
10240 bytes (10 kB) copied, 0.00445623 s, 2.3 MB/s

[root@bogon grub]# hexdump -C -n 10240 /dev/sda -v
[root@bogon grub]# reboot

```

## 修复方法：

```
grub> root (hd0,0)
grub> setup (hd0)

grub> root (hd0,0)
grub> kernel  /vm-----         [root@bogon grub]# cat grub.conf 
default=0
timeout=50
title test linux

kernel /vmlinuz-2.6.32-573.el6.x86_64  root=/dev/mapper/VolGroup-lv_root 
initrd /initramfs-2.6.32-573.el6.x86_64.img

grub> initrd /initramfs------
grub> boot

   

```

![image-20201023170638355](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023170638355.png)

## 写入grub.conf

```
[root@bogon grub]# cat grub.conf 
default=0
timeout=50
title test linux

kernel /vmlinuz-2.6.32-573.el6.x86_64  root=/dev/mapper/VolGroup-lv_root 
initrd /initramfs-2.6.32-573.el6.x86_64.img

[root@bogon grub]# reboot


```

## 准备一张图片背景

```
default=0
timeout=50
splashimage=(hd0,0)/grub/win.xpm.gz
title test linux
kernel /vmlinuz-2.6.32-573.el6.x86_64  root=/dev/mapper/VolGroup-lv_root rhgb
initrd /initramfs-2.6.32-573.el6.x86_64.img

```



```
[root@bogon ~]# convert -resize 640x480 -colors 14 shaoxh.jpg win.xpm
[root@bogon ~]# file win.xpm 
win.xpm: X pixmap image text
[root@bogon ~]# ls
anaconda-ks.cfg  install.log  install.log.syslog  shaoxh.jpg  win.xpm
[root@bogon ~]# 
[root@bogon ~]# less win.xpm 
[root@bogon ~]# 
[root@bogon ~]# gzip win.xpm 
[root@bogon ~]# ls
anaconda-ks.cfg  install.log  install.log.syslog  shaoxh.jpg  win.xpm.gz
[root@bogon ~]# mv win.xpm.gz /boot/grub/
[root@bogon ~]# reboot

```

![image-20201023175517041](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023175517041.png)

## 给菜单加入密码

```
[root@bogon ~]# openssl passwd -1
Password: 
Verifying - Password: 
$1$a5ZOpWGb$7e2vhC1AqBQc4iLdVcvWb1

```

```
[root@bogon ~]# grub-crypt 
Password: 
Retype password: 
$6$FSMPOz8R38ZUSDzd$gDDTUg6E5rHFnZ.vy3vPQ0u1h9.4X1RZJGSa5r5Pdg/4H1exRiGMsHGtWF6IsfwHyyNyk2GZXitqbcaFOUDYe0
[root@bogon ~]# 

```

## 配置文件

```
[root@bogon ~]# cat /boot/grub/grub.conf 
default=0
timeout=50
splashimage=(hd0,0)/grub/win.xpm.gz
#password magedu
password --md5 $1$a5ZOpWGb$7e2vhC1AqBQc4iLdVcvWb1 
#password --encrypted $6$FSMPOz8R38ZUSDzd$gDDTUg6E5rHFnZ.vy3vPQ0u1h9.4X1RZJGSa5r5Pdg/4H1exRiGMsHGtWF6IsfwHyyNyk2GZXitqbcaFOUDYe0 
title test linux
kernel /vmlinuz-2.6.32-573.el6.x86_64  root=/dev/mapper/VolGroup-lv_root rhgb 
initrd /initramfs-2.6.32-573.el6.x86_64.img

```

## 删除/boot/目录

```
进入救援模式
chroot /mnt/sysimage
grub-install /dev/sda

vim /boot/grub/grub.conf
default=0
timeout=50
title test linux
kernel  /vmlinuz root=/dev/mapper/VolGroup-lv_root 
initrd /initramfs.img

mount /dev/sr0 /mnt
cp /mnt/isolinux/vmlinuz /boot
cd /boot
mkinitrd initramfs.img `uname -r`
sync
sync
sync
exit
exit
reboot


```

## 删除fstab 和boot 目录

```
[root@bogon ~]# mv /etc/fstab /root
[root@bogon ~]# rm -rf /boot
rm: cannot remove `/boot': Device or resource busy
[root@bogon ~]# rm -rf /boot/*
[root@bogon ~]# ls /boot/
[root@bogon ~]# 
[root@bogon ~]# reboot

```

## 恢复方法

```
进入救援模式，因为此时找不到根，卷组时不可用的，必须先激活
vgdisplay
vgchange -ay VolGroup
lvdisplay |less
blkid
mkdir /mnt/tmp
mount /dev/mapper/VolGroup-lv_root /mnt/tmp
ls /mnt/tmp
df
cat > /mnt/tmp/etc/fstab
/dev/VolGroup/lv_root   /  ext4  defaults  0  0
/dev/VolGroup/lv_swap  swap  swap defaults 0  0
/dev/sda1 /boot ext4 defaults 0 0
ctrl +c 退出命令
reboot 重启
再次进入救援模式，这次可以找到根



```

![image-20201023190526686](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023190526686.png)

![image-20201023190743727](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023190743727.png)

![image-20201023191251210](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023191251210.png)

　　　　　　　退出救援模式，正常启动

## 查看当前的内核参数

```
[root@bogon ~]# cat /proc/cmdline 
ro root=/dev/mapper/VolGroup-lv_root
[root@bogon ~]# cat /boot/grub/grub.conf 
default=0
timeout=50
title linux

kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root
initrd /initramfs-2.6.32-573.el6.x86_64.img
[root@bogon ~]# 

```

```
[root@bogon ~]# cat /boot/grub/grub.conf 
default=0
timeout=50
title linux

kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/mapper/VolGroup-lv_root max_loop=100 selinux=0
initrd /initramfs-2.6.32-573.el6.x86_64.img
[root@bogon ~]# ls /dev/loop*|wc
    100     100    1190
[root@bogon ~]# getenforce 
Disabled
[root@bogon ~]# 

```

## 自制linux 系统

添加一个40G的硬盘，1G为boot ，30G为根

```
lsblk
echo "- - -" > /sys/class/scsi_host/host0/scan
lsblk
echo "- - -" > /sys/class/scsi_host/host2/scan
lsblk
fdisk /dev/sdb
lsblk
mkfs.ext4 /dev/sdb1
mkfs.ext4 /dev/sdb2 
blkid  
df -h  
ls /boot/
mkdir /mnt/boot
mount /dev/sdb1 /mnt/boot
cd /mnt/boot
grub-install --root-directory=/mnt /dev/sdb
ls /mnt/boot/
ls /mnt/boot/grub/
cp /boot/vmlinuz-2.6.32-573.el6.x86_64 /boot/initramfs-2.6.32-573.el6.x86_64.img /mnt/boot
ls /mnt/boot/
vim /mnt/boot/grub/grub.conf


[root@bogon ~]# cat /mnt/boot/grub/grub.conf 
default=0
timeout=30
title= shaoxianheng
root (hd0,0)
kernel /vmlinuz-2.6.32-573.el6.x86_64 ro root=/dev/sda2 selinux=0 init=/bin/bash
initrd /initramfs-2.6.32-573.el6.x86_64.img




[root@bogon ~]# mkdir /mnt/root
[root@bogon ~]# mount /dev/sdb2 /mnt/root
[root@bogon ~]# mkdir /mnt/root/{etc,boot,dev,proc,home,lib,lib64,sys,usr,bin,sbin,tmp,var}
[root@bogon ~]# ls /mnt/root
bin  boot  dev  etc  home  lib  lib64  lost+found  proc  sbin  sys  tmp  usr  var
[root@bogon ~]# rz

[root@bogon ~]# ls
anaconda-ks.cfg  copycmd.sh  install.log  install.log.syslog
[root@bogon ~]# bash copycmd.sh 
Please input a command: ^C
[root@bogon ~]# vim copycmd.sh 
[root@bogon ~]# 



[root@bogon ~]# bash copycmd.sh 
Please input a command: bash
Please input a command or quit: ls
Please input a command or quit: ping
Please input a command or quit: mount 
Please input a command or quit: insmod
Please input a command or quit: ifconfig
Please input a command or quit: ip
Please input a command or quit: cp
Please input a command or quit: tree
Please input a command or quit: mv
Please input a command or quit: useradd
Please input a command or quit: quit
[root@bogon ~]# bash copycmd.sh 
Please input a command: df
Please input a command or quit: quit

[root@bogon ~]# history
    1  tree /mnt/root
    2  yum -y install tree
    3  tree /mnt/root
    4  ethtool -i eth0
    5  modinfo e1000
    6  modinfo e1000|less
    7  cp /lib/modules/2.6.32-573.el6.x86_64/kernel/drivers/net/e1000/e1000.ko /mnt/root/lib
    8  ls /mnt/root/lib
    9  tree /mnt/root
   10  chroot /mnt/root
   12  history

[root@bogon ~]# shutdown -h now

```

启动一个新的虚拟机

```
删除磁盘，用自制的磁盘

```

![image-20201023220157124](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201023220157124.png)

源码编译http://www.linuxfromscratch.org/lfs/news.html

## proc目录

```
[root@bogon ~]# ls /proc/sys
abi  crypto  debug  dev  fs  kernel  net  vm
[root@bogon ~]# cat /proc/sys/net/ipv4/ip_forward
0
[root@bogon ~]# vim /etc/sysctl.conf 
[root@bogon ~]# 
[root@bogon ~]# grep -vE "^$|#" /etc/sysctl.conf
net.ipv4.ip_forward = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
[root@bogon ~]# 
[root@bogon ~]# sysctl -a |wc
    798    2505   28163
[root@bogon ~]# 

```

## 禁止ping

```
[root@bogon ~]# sed -i '$anet.ipv4.icmp_echo_ignore_all = 1' /etc/sysctl.conf 
[root@bogon ~]# sysctl -p
net.ipv4.ip_forward = 0
net.ipv4.conf.default.rp_filter = 1
net.ipv4.conf.default.accept_source_route = 0
kernel.sysrq = 0
kernel.core_uses_pid = 1
net.ipv4.tcp_syncookies = 1
kernel.msgmnb = 65536
kernel.msgmax = 65536
kernel.shmmax = 68719476736
kernel.shmall = 4294967296
net.ipv4.icmp_echo_ignore_all = 1


[root@bogon ~]# cat /proc/sys/net/ipv4/icmp_echo_ignore_all 
1
[root@bogon ~]# sysctl -a |wc
    798    2505   28163
[root@bogon ~]# 

```

## 临时生效-w

```
[root@bogon ~]# sysctl -w net.ipv4.ip_forward=1
net.ipv4.ip_forward = 1
[root@bogon ~]# grep forward /etc/sysctl.conf 
# Controls IP packet forwarding
net.ipv4.ip_forward = 0
[root@bogon ~]# 

```

## 共享的内存段

```

kernel.shmmax = 68719476736
[root@bogon ~]# echo  68719476736/1024/1024/1024 |bc
64 G

```

## drop_caches清空缓存

```
[root@bogon ~]# dd if=/dev/zero of=/dev/null bs=1G count=1
1+0 records in
1+0 records out
1073741824 bytes (1.1 GB) copied, 1.39472 s, 770 MB/s
[root@bogon ~]# free -h
             total       used       free     shared    buffers     cached
Mem:          981M       128M       852M       1.2M       496K        11M
-/+ buffers/cache:       116M       865M 
Swap:         1.9G        62M       1.9G 
[root@bogon ~]# cp /dev/zero /data/f1
cp: overwrite `/data/f1'? y
^C
[root@bogon ~]# free -h
             total       used       free     shared    buffers     cached
Mem:          981M       912M        68M       1.2M       660K       773M
-/+ buffers/cache:       138M       842M 
Swap:         1.9G        61M       1.9G 
[root@bogon ~]# sysctl -a |grep drop
vm.drop_caches = 0
fs.quota.drops = 0
net.core.xfrm_larval_drop = 1
[root@bogon ~]# echo 3 > /proc/sys/vm/drop_caches 
[root@bogon ~]# free -h
             total       used       free     shared    buffers     cached
Mem:          981M       125M       855M       1.2M       500K       8.5M
-/+ buffers/cache:       116M       864M 
Swap:         1.9G        61M       1.9G 
[root@bogon ~]# 

```

## /sys目录

4千多个内核功能

```
[root@bogon ~]# wc /boot/config-2.6.32-573.el6.x86_64
  4679   8097 107134 /boot/config-2.6.32-573.el6.x86_64
[root@bogon ~]# less /boot/config-2.6.32-573.el6.x86_64
[root@bogon ~]# 

```

```
[root@bogon ~]# lsmod xfs
Usage: lsmod
[root@bogon ~]# modinfo xfs
filename:       /lib/modules/2.6.32-573.el6.x86_64/kernel/fs/xfs/xfs.ko
license:        GPL
description:    SGI XFS with ACLs, security attributes, large block/inode numbers, no debug enabled
author:         Silicon Graphics, Inc.
srcversion:     943F683C5CCA1B79576154B
depends:        exportfs
vermagic:       2.6.32-573.el6.x86_64 SMP mod_unload modversions 

```

## 依赖性

```
[root@bogon ~]# lsmod |grep ext4
ext4                  378683  2      使用次数2
jbd2                   93252  1 ext4   ext4 依赖jdb2 mbcache
mbcache                 8193  1 ext4
[root@bogon ~]# 

```

## 内核编译：加入NTFS功能

```
[root@bogon data]# tar xf linux-5.1.4.tar.xz 
[root@bogon data]# ll -h
total 102M
drwxrwxr-x. 24 root root 4.0K May 22  2019 linux-5.1.4
-rw-r--r--.  1 root root 102M Oct 23  2020 linux-5.1.4.tar.xz
[root@bogon data]# du -sh .
1.1G	.
[root@bogon data]# yum -y groupinstall "Development Tools"



[root@bogon data]# cd linux-5.1.4
[root@bogon linux-5.1.4]# ls .config 
.config
[root@bogon linux-5.1.4]# cp /boot/config-2.6.32-573.el6.x86_64 .config
cp: overwrite `.config'? y
[root@bogon linux-5.1.4]# grep NTFS .config
# CONFIG_NTFS_FS is not set


[root@bogon linux-5.1.4]# make menuconfig
  HOSTCC  scripts/basic/fixdep
*
* Unable to find the ncurses package.
* Install ncurses (ncurses-devel or libncurses-dev
* depending on your distribution).
*
make[2]: *** [scripts/kconfig/mconf-cfg] Error 1
make[1]: *** [menuconfig] Error 2
make: *** [sub-make] Error 2
[root@bogon linux-5.1.4]# yum -y install ncurses-devel

进入general setup -->
     local version  (-1.0-wanglinux)
进入file systeme -->
     Dos /FAT/NT
          <M> NTFS file system support
          <*> NTFS write support
退出保存

[root@bogon linux-5.1.4]# grep NTFS .config
CONFIG_NTFS_FS=m
# CONFIG_NTFS_DEBUG is not set
CONFIG_NTFS_RW=y

[root@node1 linux-5.1.4]# make 
[root@node1 linux-5.1.4]# du -sh /lib/modules
38M	/lib/modules
[root@node1 linux-5.1.4]# make modules_install
[root@node1 linux-5.1.4]# ls /lib/modules
3.10.0-693.el7.x86_64  5.1.4-1.0-wanglinux
[root@node1 linux-5.1.4]# du -sh /lib/modules
2.6G	/lib/modules

[root@node1 linux-5.1.4]# ls /boot/
config-3.10.0-693.el7.x86_64
efi
grub
grub2
initramfs-0-rescue-29e8a05568c6400597169e022e893a92.img
initramfs-3.10.0-693.el7.x86_64.img
initramfs-3.10.0-693.el7.x86_64kdump.img
initrd-plymouth.img
symvers-3.10.0-693.el7.x86_64.gz
System.map-3.10.0-693.el7.x86_64
vmlinuz-0-rescue-29e8a05568c6400597169e022e893a92
vmlinuz-3.10.0-693.el7.x86_64

[root@node1 linux-5.1.4]# ls /boot/vmlinuz*
/boot/vmlinuz                                            /boot/vmlinuz-3.10.0-693.el7.x86_64
/boot/vmlinuz-0-rescue-29e8a05568c6400597169e022e893a92  /boot/vmlinuz-5.1.4-1.0-wanglinux
[root@node1 linux-5.1.4]# 


```

```
[root@node1 ~]# modinfo ntfs
filename:       /lib/modules/5.1.4-1.0-wanglinux/kernel/fs/ntfs/ntfs.ko
license:        GPL
version:        2.1.32
description:    NTFS 1.2/3.x driver - Copyright (c) 2001-2014 Anton Altaparmakov and Tuxera Inc.
author:         Anton Altaparmakov <anton@tuxera.com>
alias:          fs-ntfs
srcversion:     58BC116619034853825E9B3
depends:        
retpoline:      Y
intree:         Y
name:           ntfs
vermagic:       5.1.4-1.0-wanglinux SMP mod_unload modversions 

reboot

```

## 清理

```
[root@node1 linux-5.1.4]# make clean
  CLEAN   .
  CLEAN   arch/x86/entry/vdso
  CLEAN   arch/x86/kernel/cpu
  CLEAN   arch/x86/kernel
  CLEAN   arch/x86/purgatory
  CLEAN   arch/x86/realmode/rm
  CLEAN   arch/x86/lib
  CLEAN   certs
  CLEAN   drivers/firmware/efi/libstub
  CLEAN   drivers/gpu/drm/radeon
  CLEAN   drivers/scsi/aic7xxx
  CLEAN   drivers/scsi
  CLEAN   drivers/tty/vt
  CLEAN   drivers/video/logo
  CLEAN   kernel/debug/kdb
  CLEAN   lib/raid6
  CLEAN   lib
  CLEAN   net/wireless
  CLEAN   security/selinux
  CLEAN   usr
  CLEAN   arch/x86/boot/compressed
  CLEAN   arch/x86/boot
  CLEAN   arch/x86/tools
  CLEAN   .tmp_versions
[root@node1 linux-5.1.4]# du -sh .
942M	.
[root@node1 linux-5.1.4]# 
[root@node1 linux-5.1.4]# cd ..
[root@node1 data]# ls
linux-5.1.4
[root@node1 data]# rm -rf linux-5.1.4/
[root@node1 data]# 

```

## 编译busybox

```
[root@node1 ~]# ls
busybox-1.30.0.tar.bz2
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# tar xf busybox-1.30.0.tar.bz2 
[root@node1 ~]# cd busybox-1.30.0/
[root@node1 busybox-1.30.0]# make menuconfig

```

```
 Settings  ---> 
  [*] Build static binary (no shared libs)
  exit
  exit
  yes
```

```
yum -y install libgcrypt-devel
yum -y install glibc-static
yum -y install gcc-c++
yum -y install epel*
yum -y install libmcrypt-devel

[root@node1 busybox-1.30.0]# make && make install
[root@node1 busybox-1.30.0]# mkdir /mnt/sysroot
[root@node1 busybox-1.30.0]# cp -a _install/* /mnt/sysroot/
[root@node1 busybox-1.30.0]# cd /mnt/sysroot/
[root@node1 sysroot]# ll
total 8
drwxr-xr-x. 2 root root 4096 Oct 24 17:30 bin
lrwxrwxrwx. 1 root root   11 Oct 24 17:30 linuxrc -> bin/busybox
drwxr-xr-x. 2 root root 4096 Oct 24 17:30 sbin
drwxr-xr-x. 4 root root   29 Oct 24 17:30 usr
[root@node1 sysroot]# 
[root@node1 busybox-1.30.0]# ./busybox hostname
node1
[root@node1 busybox-1.30.0]# 
[root@node1 busybox-1.30.0]# cd _install/
[root@node1 _install]# ls
bin  linuxrc  sbin  usr
[root@node1 _install]# mkdir -p /data/linux
[root@node1 _install]# cp -a * /data/linux/
[root@node1 _install]# cd /data/linux/
[root@node1 linux]# ls
bin  linuxrc  sbin  usr
[root@node1 linux]# cd bin/
[root@node1 bin]# ./cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin


[root@node1 bin]# cd ..
[root@node1 linux]# ls
bin  linuxrc  sbin  usr
[root@node1 linux]# find -type l |wc -l
393
[root@node1 linux]# 


```

## Centos源

```
[root@bogon yum.repos.d]# cat centos.repo 
[base]
name=centos
baseurl=https://mirrors.aliyun.com/centos/6/os/x86_64
gpgcheck=0

[epel]
name=epel
baseurl=http://mirrors.aliyun.com/epel/$releasever/$basearch
gpgcheck=0
enabled=1

```

##  epel源支持的ntfs文件系统，不用编译

```
[root@node1 sysroot]# yum -y install ntfs-3g

```

## systemd特性：

```
[root@node1 multi-user.target.wants]# ll httpd
ls: cannot access httpd: No such file or directory
[root@node1 multi-user.target.wants]# systemctl enable httpd
Created symlink from /etc/systemd/system/multi-user.target.wants/httpd.service to /usr/lib/systemd/system/httpd.service.
[root@node1 multi-user.target.wants]# ll httpd.service 
lrwxrwxrwx. 1 root root 37 Oct 24 23:13 httpd.service -> /usr/lib/systemd/system/httpd.service
[root@node1 multi-user.target.wants]# pwd
/etc/systemd/system/multi-user.target.wants
[root@node1 multi-user.target.wants]# 

```

## 禁止启动

```
[root@node1 yum.repos.d]# systemctl mask httpd
Created symlink from /etc/systemd/system/httpd.service to /dev/null.
[root@node1 yum.repos.d]# systemctl start httpd
Failed to start httpd.service: Unit is masked.
[root@node1 yum.repos.d]# 

```

## 取消禁止

```
[root@node1 yum.repos.d]# systemctl unmask httpd
Removed symlink /etc/systemd/system/httpd.service.
[root@node1 yum.repos.d]# systemctl start httpd
[root@node1 yum.repos.d]# lsof -i :80
COMMAND   PID   USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
httpd   14013   root    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
httpd   14015 apache    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
httpd   14016 apache    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
httpd   14017 apache    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
httpd   14018 apache    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
httpd   14019 apache    4u  IPv6  49403      0t0  TCP *:http (LISTEN)
[root@node1 yum.repos.d]# 

```

## 查看是否活动

```
[root@node1 yum.repos.d]# systemctl is-active httpd
active
[root@node1 yum.repos.d]# systemctl stop httpd

[root@node1 yum.repos.d]# systemctl is-active httpd
unknown
[root@node1 yum.repos.d]# echo $?
3
[root@node1 yum.repos.d]# 

```

## centos6 启动nfs时，依赖rpcbind

```
[root@bogon yum.repos.d]# service nfs status
rpc.svcgssd is stopped
rpc.mountd is stopped
nfsd is stopped
rpc.rquotad is stopped
[root@bogon yum.repos.d]# service rpcbind status
rpcbind (pid  1722) is running...
[root@bogon yum.repos.d]# service nfs start
Starting NFS services:                                     [  OK  ]
Starting NFS quotas:                                       [  OK  ]
Starting NFS mountd:                                       [  OK  ]
Starting NFS daemon:                                       [  OK  ]
Starting RPC idmapd:                                       [  OK  ]
[root@bogon yum.repos.d]# 

```

```
[root@bogon yum.repos.d]# service rpcbind stop
Stopping rpcbind:                                          [  OK  ]
[root@bogon yum.repos.d]# service nfs restart
Shutting down NFS daemon:                                  [  OK  ]
Shutting down NFS mountd:                                  [  OK  ]
Shutting down NFS quotas:                                  [  OK  ]
Shutting down RPC idmapd:                                  [  OK  ]
Starting NFS services:                                     [  OK  ]
Starting NFS quotas: Cannot register service: RPC: Unable to receive; errno = Connection refused
rpc.rquotad: unable to register (RQUOTAPROG, RQUOTAVERS, udp).
                                                           [FAILED]
Starting NFS mountd:                                       [FAILED]
Starting NFS daemon: 

```

## centos7 自动激活依赖的服务

```
root@node1 yum.repos.d]# systemctl status rpcbind nfs-server
● rpcbind.service - RPC bind service
   Loaded: loaded (/usr/lib/systemd/system/rpcbind.service; indirect; vendor preset: enabled)
   Active: inactive (dead)

● nfs-server.service - NFS server and services
   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)
   Active: inactive (dead)
[root@node1 yum.repos.d]# systemctl nfs-server
Unknown operation 'nfs-server'.
[root@node1 yum.repos.d]# systemctl start nfs-server
[root@node1 yum.repos.d]# systemctl status rpcbind nfs-server
● rpcbind.service - RPC bind service
   Loaded: loaded (/usr/lib/systemd/system/rpcbind.service; indirect; vendor preset: enabled)
   Active: active (running) since Sat 2020-10-24 23:40:37 CST; 5s ago
  Process: 14191 ExecStart=/sbin/rpcbind -w $RPCBIND_ARGS (code=exited, status=0/SUCCESS)
 Main PID: 14192 (rpcbind)
   CGroup: /system.slice/rpcbind.service
           └─14192 /sbin/rpcbind -w

Oct 24 23:40:37 node1 systemd[1]: Starting RPC bind service...
Oct 24 23:40:37 node1 systemd[1]: Started RPC bind service.

● nfs-server.service - NFS server and services
   Loaded: loaded (/usr/lib/systemd/system/nfs-server.service; disabled; vendor preset: disabled)
   Active: active (exited) since Sat 2020-10-24 23:40:37 CST; 5s ago
  Process: 14203 ExecStart=/usr/sbin/rpc.nfsd $RPCNFSDARGS (code=exited, status=0/SUCCESS)
  Process: 14197 ExecStartPre=/bin/sh -c /bin/kill -HUP `cat /run/gssproxy.pid` (code=exited, status=0/SUCCESS)
  Process: 14195 ExecStartPre=/usr/sbin/exportfs -r (code=exited, status=0/SUCCESS)
 Main PID: 14203 (code=exited, status=0/SUCCESS)
   CGroup: /system.slice/nfs-server.service

Oct 24 23:40:37 node1 systemd[1]: Starting NFS server and services...
Oct 24 23:40:37 node1 systemd[1]: Started NFS server and services.
[root@node1 yum.repos.d]# 

```

```
[root@node1 ~]# rpm -ql telnet-server
/usr/lib/systemd/system/telnet.socket
/usr/lib/systemd/system/telnet@.service
/usr/sbin/in.telnetd
/usr/share/man/man5/issue.net.5.gz
/usr/share/man/man8/in.telnetd.8.gz
/usr/share/man/man8/telnetd.8.gz
[root@node1 ~]# systemctl status telnet.socket
● telnet.socket - Telnet Server Activation Socket
   Loaded: loaded (/usr/lib/systemd/system/telnet.socket; disabled; vendor preset: disabled)
   Active: inactive (dead)
     Docs: man:telnetd(8)
   Listen: [::]:23 (Stream)
 Accepted: 0; Connected: 0
[root@node1 ~]# ss -tnl |grep 23
[root@node1 ~]# systemctl start telnet-socket
Failed to start telnet-socket.service: Unit not found.
[root@node1 ~]# systemctl start telnet.socket
[root@node1 ~]# ss -tnl |grep 23
LISTEN     0      128         :::23                      :::*                  
[root@node1 ~]# ss -tnlp |grep 23
LISTEN     0      128          *:22                       *:*                   users:(("sshd",pid=1235,fd=3))
LISTEN     0      128    127.0.0.1:631                      *:*                   users:(("cupsd",pid=1236,fd=12))
LISTEN     0      128         :::22                      :::*                   users:(("sshd",pid=1235,fd=4))
LISTEN     0      128         :::23                      :::*                   users:(("systemd",pid=1,fd=26))
LISTEN     0      128        ::1:631                     :::*                   users:(("cupsd",pid=1236,fd=11))
[root@node1 ~]# 

```

## 查看某服务当前激活与否的状态

```
[root@node1 ~]# systemctl is-active httpd
unknown
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# systemctl start httpd
[root@node1 ~]# systemctl is-active httpd
active
[root@node1 ~]# 

```

## 查看所有已经激活的服务

```
root@node1 ~]# systemctl list-units -t service 

```

## 查看所有服务

```
[root@node1 ~]# systemctl list-units -t service -a

```

## 查看依赖关系

```
[root@node1 ~]# systemctl list-dependencies httpd

```

## 杀掉进程：

```
[root@node1 ~]# systemctl kill httpd

```

服务单元unit

```
[root@node1 system]# cat atd.service 
[Unit]
Description=Job spooling tools
After=syslog.target systemd-user-sessions.service

[Service]
EnvironmentFile=/etc/sysconfig/atd
ExecStart=/usr/sbin/atd -f $OPTS
IgnoreSIGPIPE=no

[Install]
WantedBy=multi-user.target
[root@node1 system]# pwd
/usr/lib/systemd/system

```



## 服务脚本定义

```
[root@node1 data]# cat bak.sh 
#!/bin/bash
#
tar cf /data/etc.tar /etc/ &> /dev/null
[root@node1 data]# 
[root@node1 data]# cd /usr/lib/systemd/system
[root@node1 system]# cat bak.service 
[Unit]
Description=backup /etc
Requires=atd.service
[Service]
Type=simple
ExecStart=/bin/bash -c "echo /data/bak.sh|at now"
[Install]
WantedBy=multi-user.target
[root@node1 system]# 
347  systemctl daemon-reload 
  348  systemctl list-units -t service 
  349  systemctl status bak.service 
  350  systemctl start bak.service 
  351  systemctl status bak.service 


```

## 运行级别

```
[root@node1 system]# pwd 
/usr/lib/systemd/system
[root@node1 system]# ll *.target
lrwxrwxrwx. 1 root root  15 Aug 27 20:57 runlevel0.target -> poweroff.target
lrwxrwxrwx. 1 root root  13 Aug 27 20:57 runlevel1.target -> rescue.target
lrwxrwxrwx. 1 root root  17 Aug 27 20:57 runlevel2.target -> multi-user.target
lrwxrwxrwx. 1 root root  17 Aug 27 20:57 runlevel3.target -> multi-user.target
lrwxrwxrwx. 1 root root  17 Aug 27 20:57 runlevel4.target -> multi-user.target
lrwxrwxrwx. 1 root root  16 Aug 27 20:57 runlevel5.target -> graphical.target
lrwxrwxrwx. 1 root root  13 Aug 27 20:57 runlevel6.target -> reboot.target

```

## 切换运行级别

```
[root@node1 system]# runlevel 
N 5
[root@node1 system]# systemctl isolate multi-user.target 
[root@node1 system]# runlevel 
5 3
[root@node1 system]# 
[root@node1 system]# systemctl isolate graphical.target


```

##   设置默认的启动字符界面

```
[root@node1 system]# vim /etc/inittab 
[root@node1 system]# 
[root@node1 system]# systemctl get-default 
graphical.target
[root@node1 system]# systemctl set-default multi-user.target 
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.
[root@node1 system]# 

```

##    reboot 命令指向systemctl的软链接

```
[root@node1 ~]# ll /usr/sbin/reboot 
lrwxrwxrwx. 1 root root 16 Aug 27 20:57 /usr/sbin/reboot -> ../bin/systemctl

```

## CentOS7 启动模板

```
[root@node1 grub2]# ll /boot/grub2/grub.cfg 
-rw-r--r--. 1 root root 4323 Aug 27 21:23 /boot/grub2/grub.cfg
[root@node1 grub2]# cat /etc/default/grub 
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos_node1/root rd.lvm.lv=centos_node1/swap rhgb quiet"
GRUB_DISABLE_RECOVERY="true"
[root@node1 grub2]# 

```

```
[root@node1 grub2]# cat /etc/default/grub 
GRUB_TIMEOUT=5
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
GRUB_CMDLINE_LINUX="crashkernel=auto rd.lvm.lv=centos_node1/root rd.lvm.lv=centos_node1/swap rhgb quiet net.ifnames=0"
GRUB_DISABLE_RECOVERY="true"
[root@node1 grub2]# grub2-mk
grub2-mkconfig         grub2-mkimage          grub2-mknetdir         grub2-mkrelpath        grub2-mkstandalone     
grub2-mkfont           grub2-mklayout         grub2-mkpasswd-pbkdf2  grub2-mkrescue         
[root@node1 grub2]# grub2-mkconfig -o /boot/grub2/grub.cfg 
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.10.0-693.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-693.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-29e8a05568c6400597169e022e893a92
Found initrd image: /boot/initramfs-0-rescue-29e8a05568c6400597169e022e893a92.img
done
[root@node1 grub2]# 

```

## 删除grub.cfg可以用命令恢复

```
[root@node1 ~]# rm -f /boot/grub2/grub.cfg 
[root@node1 ~]# grub2-mkconfig -o /boot/grub2/grub.cfg
Generating grub configuration file ...
Found linux image: /boot/vmlinuz-3.10.0-693.el7.x86_64
Found initrd image: /boot/initramfs-3.10.0-693.el7.x86_64.img
Found linux image: /boot/vmlinuz-0-rescue-29e8a05568c6400597169e022e893a92
Found initrd image: /boot/initramfs-0-rescue-29e8a05568c6400597169e022e893a92.img
done
[root@node1 ~]# 

```

## target依赖关系

```
  cat default.target
  cat /usr/lib/systemd/system/basic.target
  cat /usr/lib/systemd/system/sysinit.target
  systemctl list-dependencies sysinit.target
  systemd-analyze dump
  systemd-analyze plot 
  systemd-analyze plot > /data/boot.xml


```

开机启动的服务

```
[root@node1 data]# systemctl get-default 
multi-user.target
[root@node1 data]# ll /etc/systemd/system/multi-user.target.wants/
total 0
lrwxrwxrwx. 1 root root 41 Aug 27 20:58 abrt-ccpp.service -> /usr/lib/systemd/system/abrt-ccpp.service
lrwxrwxrwx. 1 root root 37 Aug 27 20:57 abrtd.service -> /usr/lib/systemd/system/abrtd.service
lrwxrwxrwx. 1 root root 41 Aug 27 20:57 abrt-oops.service -> /usr/lib/systemd/system/abrt-oops.service
lrwxrwxrwx. 1 root root 43 Aug 27 20:58 abrt-vmcore.service -> /usr/lib/systemd/system/abrt-vmcore.service
lrwxrwxrwx. 1 root root 41 Aug 27 20:57 abrt-xorg.service -> /usr/lib/systemd/system/abrt-xorg.service

```

## 如果设置了重启模式

```
[root@node1 data]# systemctl set-default reboot.target 
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/reboot.target.
[root@node1 data]# reboot

```

## 修复方法

```
启动时，在linux16行后添加systemd.unit=multi-user.target
[root@node1 ~]# systemctl set-default multi-user.target
Removed symlink /etc/systemd/system/default.target.
Created symlink from /etc/systemd/system/default.target to /usr/lib/systemd/system/multi-user.target.
[root@node1 ~]# 

```

![image-20201026100945205](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201026100945205.png)



破解centos7 的口令

```
破解CentOS7的root口令方法一
启动时任意键暂停启动
按e键进入编辑模式
将光标移动linux16开始的行，添加内核参数rd.break
按ctrl-x启动
mount –o remount,rw /sysroot
chroot /sysroot
passwd root
touch /.autorelabel
exit
reboot
```

## 修复GRUB2

```

GRUB“the Grand Unified Bootloader”
引导提示时可以使用命令行界面
可从文件系统引导
主要配置文件 /boot/grub2/grub.cfg
修复配置文件
grub2-mkconfig > /boot/grub2/grub.cfg
修复grub
grub2-install /dev/sda BIOS环境
grub2-install UEFI环境
调整默认启动内核
vim /etc/default/grub
GRUB_DEFAULT=0
```

## 给菜单加上密码

```
boot/grub2下面会有一个 user.cfg生成
[root@node1 ~]# grub2-setpassword 
Enter password: 
Confirm password: 
[root@node1 ~]# ls /boot/grub2/
device.map  fonts  grub.cfg  grubenv  i386-pc  locale  user.cfg
[root@node1 ~]# 

```

## 破坏grub文件

```
[root@node1 ~]# rm -rf /boot/grub*
[root@node1 ~]# reboot
进入光盘救援模式--》troubleshooting
sh-4.2# chroot /mnt/sysimage
sh-4.2# grub2-install /dev/sda
sh-4.2# grub2-mkconfig -o /boot/grub2/grub.cfg
sh-4.2# exit
bash-4.2# reboot
硬盘正常启动

```

删除boot目录内容

```
[root@node1 ~]# rm -rf /boot/*
[root@node1 ~]# ls /boot/
[root@node1 ~]# reboot 

```

修复

```
chroot /mnt/sysimage
mount /dev/sr0 /nnt
rpm -ivh /mnt/Packages/  --force
grub2-install /dev/sda
grub2-mkconfig -o /boot/grub2/grub.cfg
sync
sync
sync
exit
reboot

```

![image-20201026110419575](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201026110419575.png)

![image-20201026110625689](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201026110625689.png)