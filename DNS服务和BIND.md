# DNS服务和BIND

## 1.1 查看域名信息

```
[root@node1 ~]# whois loongson.cn
Domain Name: loongson.cn
ROID: 20060627s10001s56158083-cn
Domain Status: ok
Registrant: 龙芯中科技术有限公司
Registrant Contact Email: lixiaoyu@loongson.cn
Sponsoring Registrar: 阿里云计算有限公司（万网）
Name Server: ns1.dnsv3.com
Name Server: ns2.dnsv3.com
Registration Time: 2006-06-27 10:27:06
Expiration Time: 2027-06-27 10:27:06
DNSSEC: unsigned

```

## 1.2 搭建dns服务器

```
[root@node1 ~]# yum -y install bind
[root@node1 ~]# rpm -ql bind|grep service
/usr/lib/systemd/system/named-setup-rndc.service
/usr/lib/systemd/system/named.service

```

### 1.2.1 定义127.0.0.1为DNS

```
[root@node1 ~]# echo DNS1=127.0.0.1 >> /etc/sysconfig/network-scripts/ifcfg-ens33
[root@node1 ~]# systemctl restart network
[root@node1 ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 127.0.0.1
[root@node1 ~]# ping www.baidu.com
PING www.a.shifen.com (39.156.66.18) 56(84) bytes of data.
64 bytes from 39.156.66.18 (39.156.66.18): icmp_seq=1 ttl=50 time=44.3 ms


```

### 1.2.2 mii-tool 网线断或者交换机

```
[root@node2 ~]# mii-tool ens33
ens33: negotiated 1000baseT-FD flow-control, link no


[root@node2 ~]# ethtool  ens33
Settings for ens33:
	Supported ports: [ TP ]
	Supported link modes:   10baseT/Half 10baseT/Full 
	                        100baseT/Half 100baseT/Full 
	                        1000baseT/Full 
	Supported pause frame use: No
	Supports auto-negotiation: Yes
	Advertised link modes:  10baseT/Half 10baseT/Full 
	                        100baseT/Half 100baseT/Full 
	                        1000baseT/Full 
	Advertised pause frame use: No
	Advertised auto-negotiation: Yes
	Speed: 1000Mb/s
	Duplex: Full
	Port: Twisted Pair
	PHYAD: 0
	Transceiver: internal
	Auto-negotiation: on
	MDI-X: off (auto)
	Supports Wake-on: d
	Wake-on: d
	Current message level: 0x00000007 (7)
			       drv probe link
	Link detected: no
[root@node2 ~]# 

```

### 1.2.3 缓存dns服务器搭建

```
[root@node1 ~]# vim /etc/named.conf 
修改下面两行内容

listen-on port 53 { localhost; };
allow-query     { any; };

[root@node1 ~]# systemctl restart named
[root@node1 ~]# rndc reload


```

## 2.1.1 配置主服务器：

```
执行命令如下：
    vim /etc/named.rfc1912.zones

 末尾出添加如下几行

    zone "magedu.com" IN {

          type master;

          file "magedu.com.zone";
};

 
```

### 2.1.2 定义正向区域解析库文件

```
[root@node1 named]# pwd
/var/named
[root@node1 named]# cp -p named.localhost magedu.com.zone 
$TTL 1D
@       IN SOA  master.magedu.com. admin.magedu.com. (
                                        0       ; serial
                                        1D      ; refresh
                                        1H      ; retry
                                        1W      ; expire
                                        3H )    ; minimum
        NS     master
master  A 192.168.0.111
ftp     A 1.1.1.1
db      A 2.2.2.2
www     CNAME websrv
websrv  A 192.168.0.11
websrv  A 192.168.0.12
@       MX 10 mailsrv
mailsrv A 3.3.3.3

```

### 2.1.3 重载服务

```
[root@node1 named]# rndc reload
server reload successful

```

### 2.1.4 测试解析

```
[root@node1 named]# host ftp.magedu.com
ftp.magedu.com has address 1.1.1.1
[root@node1 named]# host db.magedu.com
db.magedu.com has address 2.2.2.2
[root@node1 named]# host mailsrv.magedu.com
mailsrv.magedu.com has address 3.3.3.3

```

### 2.1.1 解析1-100

```
[root@node1 named]# cat magedu.com.zone 
$TTL 86400
@               IN           SOA        ns1.magedu.com. admin.magedu.com. ( 1 3H 10M 12H 1H) 
                             NS         ns1
ns1                          A          192.168.1.111
ftp 	                     A          1.1.1.1
websrv                       A          2.2.2.2
websrv                       A          3.3.3.3
www	                     CNAME      websrv
@                             A          4.4.4.4
$GENERATE   1-100 server$   A            10.0.0.$

```

### 2.1.2 结果

```
[root@node1 named]# host  server11.magedu.com localhost
Using domain server:
Name: localhost
Address: ::1#53
Aliases: 

server11.magedu.com has address 10.0.0.11
[root@node1 named]# 

```

### 2.2.1 通配*

```
[root@node1 named]# cat magedu.com.zone 
$TTL 86400
@               IN           SOA        ns1.magedu.com. admin.magedu.com. ( 1 3H 10M 12H 1H) 
                             NS         ns1
ns1                          A          192.168.1.111
ftp 	                     A          1.1.1.1
websrv                       A          2.2.2.2
websrv                       A          3.3.3.3
www	                     CNAME      websrv
@                             A          4.4.4.4
$GENERATE   1-100 server$   A            10.0.0.$
*                             A          5.5.5.5

```

### 2.2.2 结果

```
[root@node1 named]# host  wwwwwwww.magedu.com localhost
Using domain server:
Name: localhost
Address: ::1#53
Aliases: 

wwwwwwww.magedu.com has address 5.5.5.5

```

### 2.3.1 定义反向区域解析库文件

```
[root@node1 named]# cat /var/named/192.168.0.zone 
$TTL 1D
@          IN      SOA  ns1.magedu.com. admin ( 1 1D 1H 1W 2D)
                   NS   ns1
ns1                A    192.168.0.111
112                PTR  ftp.magedu.com.
111                PTR  ns1.magedu.com.
113                PTR  websrv.magedu.com.
114                PTR  websrv.magedu.com.

```

### 2.3.2 定义反向区域文件文件

```
[root@node1 named]# vim /etc/named.rfc1912.zones 
......
zone "0.168.192.in-addr.arpa" IN {
        type master;
        file "192.168.0.zone";
};

```

### 2.3.3 修改一下正向库

```
[root@node1 named]# cat /var/named/magedu.com.zone 
$TTL 86400
@               IN           SOA        ns1.magedu.com. admin.magedu.com. ( 1 3H 10M 12H 1H) 
                             NS         ns1
ns1                          A          192.168.0.111
ftp 	                     A          192.168.0.112
websrv                       A          192.168.0.113
websrv                       A          192.168.0.114
www	                     CNAME      websrv
@                             A          192.168.0.115
$GENERATE   1-100 server$   A            10.0.0.$
*                             A          192.168.0.116

```



### 2.3.4 检查配置文件和区域文件&&重载服务

```
[root@node1 named]# named-checkconf 
[root@node1 named]# named-checkzone "magedu.com" 192.168.0.zone 
zone magedu.com/IN: loaded serial 1
OK
[root@node1 named]# 
[root@node1 named]# 
[root@node1 named]# named-checkzone "magedu.com" magedu.com.zone 
zone magedu.com/IN: loaded serial 1
OK
[root@node1 named]# rndc reload
server reload successful

```

### 2.3.5 测试结果

```
[root@node1 named]# dig -t ptr 113.0.168.192.in-addr.arpa @localhost

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> -t ptr 113.0.168.192.in-addr.arpa @localhost
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10296
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;113.0.168.192.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
113.0.168.192.in-addr.arpa. 86400 IN	PTR	websrv.magedu.com.

;; AUTHORITY SECTION:
0.168.192.in-addr.arpa.	86400	IN	NS	ns1.0.168.192.in-addr.arpa.

;; ADDITIONAL SECTION:
ns1.0.168.192.in-addr.arpa. 86400 IN	A	192.168.0.111

;; Query time: 0 msec
;; SERVER: ::1#53(::1)
;; WHEN: Wed Nov 04 01:01:07 EST 2020
;; MSG SIZE  rcvd: 120

```

```
[root@node1 named]# dig -x 192.168.0.112 @localhost

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> -x 192.168.0.112 @localhost
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 26617
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;112.0.168.192.in-addr.arpa.	IN	PTR

;; ANSWER SECTION:
112.0.168.192.in-addr.arpa. 86400 IN	PTR	ftp.magedu.com.

;; AUTHORITY SECTION:
0.168.192.in-addr.arpa.	86400	IN	NS	ns1.0.168.192.in-addr.arpa.

;; ADDITIONAL SECTION:
ns1.0.168.192.in-addr.arpa. 86400 IN	A	192.168.0.111

;; Query time: 1 msec
;; SERVER: ::1#53(::1)
;; WHEN: Wed Nov 04 01:01:57 EST 2020
;; MSG SIZE  rcvd: 117


```

## 3.1.1 配置从服务器

```
[root@node2 ~]# yum -y install bind
[root@node2 ~]# cat /etc/named.conf 
options {
//	listen-on port 53 { 127.0.0.1; };
	listen-on-v6 port 53 { ::1; };
	directory 	"/var/named";
	dump-file 	"/var/named/data/cache_dump.db";
	statistics-file "/var/named/data/named_stats.txt";
	memstatistics-file "/var/named/data/named_mem_stats.txt";
	recursing-file  "/var/named/data/named.recursing";
	secroots-file   "/var/named/data/named.secroots";
//	allow-query     { localhost; };

注释两行：
```

### 3.1.2 加入域配置文件

```
[root@node2 slaves]# vim /etc/named.rfc1912.zones 
.....
zone "magedu.com" IN {
        type slave;
        masters {192.168.0.111;};
        file "slaves/magedu.com.zone";
};

```

### 3.1.3 启动从服务器

```
[root@node2 slaves]# systemctl start named

```

### 3.1.4 测试是否查询

```
[root@node2 slaves]# dig www.magedu.com @localhost

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> www.magedu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 64384
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 1, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;www.magedu.com.			IN	A

;; ANSWER SECTION:
www.magedu.com.		86400	IN	CNAME	websrv.magedu.com.
websrv.magedu.com.	86400	IN	A	192.168.0.114
websrv.magedu.com.	86400	IN	A	192.168.0.113

```

## 4.1.1 主DNS解析库发生改变，同步从服务器

```

[root@node1 named]# cat /var/named/magedu.com.zone 
$TTL 86400
@               IN           SOA        ns1.magedu.com. admin.magedu.com. ( 2 3H 10M 12H 1H) 
                             NS         ns1                                  修改版本号
                             NS         ns2       加入从服务器
ns2                          A          192.168.0.112
ns1                          A          192.168.0.111
ftp 	                     A          192.168.0.112
websrv                       A          192.168.0.113
websrv                       A          192.168.0.114
www	                     CNAME      websrv
@                             A          192.168.0.115
$GENERATE   1-100 server$   A            10.0.0.$
*                             A          192.168.0.116
blog                          A          192.168.0.117     增加的A记录

[root@node1 named]# rndc reload
server reload successful
[root@node1 named]# 

```

### 4.1.2 从服务器会同步

```
-rw-r--r--. 1 named named 5124 Nov  4 03:10 magedu.com.zone
[root@node2 slaves]# 
[root@node2 slaves]# 
[root@node2 slaves]# ll
total 8
-rw-r--r--. 1 named named 5227 Nov  4 03:23 magedu.com.zone

```

```
[root@node2 slaves]# dig blog.magedu.com @localhost

; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> blog.magedu.com @localhost
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45596
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 3

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;blog.magedu.com.		IN	A

;; ANSWER SECTION:
blog.magedu.com.	86400	IN	A	192.168.0.117


```

### 4.1.3 利用dig命令抓取主服务器的数据

```
[root@node5 ~]# dig -t axfr magedu.com @192.168.0.111

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> -t axfr magedu.com @192.168.0.111
;; global options: +cmd
magedu.com.		86400	IN	SOA	ns1.magedu.com. admin.magedu.com. 2 10800 600 43200 3600
magedu.com.		86400	IN	A	192.168.0.115
magedu.com.		86400	IN	NS	ns1.magedu.com.
magedu.com.		86400	IN	NS	ns2.magedu.com.

```

## 5.1.1 主服务器加入安全机制

```
allow-transfer {192.168.0.112;};
[root@node1 named]# systemctl restart named

```

### 5.1.2 再次抓取将会失败

```
[root@node5 ~]# dig -t axfr magedu.com @192.168.0.111

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> -t axfr magedu.com @192.168.0.111
;; global options: +cmd
; Transfer failed.

```

### 5.1.3 从服务器也要加入安全机制

```
allow-transfer {none;};
[root@node2 slaves]# systemctl restart named

```

## 6.1.1 配置一台主机的DNS指向主和从

```
[root@node5 ~]# vim /etc/sysconfig/network-scripts/ifcfg-eth0 
加入两行
DNS1=192.168.0.111
DNS2=192.168.0.112
重启网络服务
[root@node5 ~]# cat /etc/resolv.conf 
# Generated by NetworkManager
nameserver 192.168.0.111
nameserver 192.168.0.112

```

### 6.1.2主down机，客户端可以使用从服务器获取解析

```
[root@node1 named]# systemctl stop named

```

```
[root@node5 ~]# dig -t a magedu.com 

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> -t a magedu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 42825
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 2

;; QUESTION SECTION:
;magedu.com.			IN	A

;; ANSWER SECTION:
magedu.com.		86400	IN	A	192.168.0.115

;; AUTHORITY SECTION:
magedu.com.		86400	IN	NS	ns2.magedu.com.
magedu.com.		86400	IN	NS	ns1.magedu.com.

;; ADDITIONAL SECTION:
ns1.magedu.com.		86400	IN	A	192.168.0.111
ns2.magedu.com.		86400	IN	A	192.168.0.112

;; Query time: 6 msec
;; SERVER: 192.168.0.112#53(192.168.0.112)        从服务器获取
;; WHEN: Wed Nov  4 17:00:46 2020
;; MSG SIZE  rcvd: 112


```

### 6.1.3 主服务器上线后，

```
[root@node1 named]# systemctl start named
```

```
[root@node5 ~]# dig -t a magedu.com 

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> -t a magedu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2273
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 2

;; QUESTION SECTION:
;magedu.com.			IN	A

;; ANSWER SECTION:
magedu.com.		86400	IN	A	192.168.0.115

;; AUTHORITY SECTION:
magedu.com.		86400	IN	NS	ns1.magedu.com.
magedu.com.		86400	IN	NS	ns2.magedu.com.

;; ADDITIONAL SECTION:
ns1.magedu.com.		86400	IN	A	192.168.0.111
ns2.magedu.com.		86400	IN	A	192.168.0.112

;; Query time: 0 msec
;; SERVER: 192.168.0.111#53(192.168.0.111)
;; WHEN: Wed Nov  4 17:01:46 2020
;; MSG SIZE  rcvd: 112

```

## 7.1.1 创建beijing子域

```
[root@node1 named]# cp -p magedu.com.zone beijing.magedu.com.zone
[root@node1 named]# cat /var/named/beijing.magedu.com.zone 
$TTL 86400
@               IN           SOA        ns1 admin ( 3 3H 10M 12H 1H) 
                             NS         ns1
ns1                          A          192.168.0.111
websrv                       A          192.168.0.113
www	                     CNAME      websrv

[root@node1 named]# vim /etc/named.rfc1912.zones
加入一下几行

zone "beijing.magedu.com" IN {
        type master;
        file "beijing.magedu.com.zone";
};

[root@node1 named]# rndc reload
server reload successful


```

### 7.1.2 测试结果

```
[root@node5 ~]# dig www.beijing.magedu.com

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> www.beijing.magedu.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 53399
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;www.beijing.magedu.com.		IN	A

;; ANSWER SECTION:
www.beijing.magedu.com.	86400	IN	CNAME	websrv.beijing.magedu.com.
websrv.beijing.magedu.com. 86400 IN	A	192.168.0.113

;; AUTHORITY SECTION:
beijing.magedu.com.	86400	IN	NS	ns1.beijing.magedu.com.

;; ADDITIONAL SECTION:
ns1.beijing.magedu.com.	86400	IN	A	192.168.0.111

;; Query time: 0 msec
;; SERVER: 192.168.0.111#53(192.168.0.111)
;; WHEN: Wed Nov  4 20:04:01 2020
;; MSG SIZE  rcvd: 111

```

## 8.1.1 子域单独使用一台主机的配置

```
[root@node3 named]# iptables -F
[root@node3 named]# setenforce 0
[root@node3 named]# vim /etc/named.conf 
注释两行
[root@node3 named]# vim /etc/named.rfc1912.zones
zone "zhengzhou.magedu.com" {
        type master;
        file "zhengzhou.magedu.com.zone";
};

[root@node3 named]# vim /var/named/zhengzhou.magedu.com.zone
$TTL 86400
@     IN      SOA   ns1  admin  ( 1 3H 10M 12H 1H )
              NS    ns1
ns1           A     192.168.0.113
websrv        A     192.168.0.113
www           CNAME websrv


[root@node3 named]# chmod 640 zhengzhou.magedu.com.zone
[root@node3 named]# chgrp named zhengzhou.magedu.com.zone 
[root@node3 named]# systemctl start named



```

### 8.1.2 需要在主服务器上面加入子域的NS记录（修改版本号）

```
zhengzhou                    NS         ns3
ns3                          A          192.168.0.113

```

### 8.1.3 关闭des的dnssec

```
[root@node1 named]# vim /etc/named.conf 
dnssec-enable no;      安全加密功能关闭
dnssec-validation no;
root@node1 named]# systemctl restart named


```

### 8.1.4 客户端测试

```
[root@node5 ~]# dig www.zhengzhou.magedu.com @192.168.0.111

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> www.zhengzhou.magedu.com @192.168.0.111
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 4089
;; flags: qr rd ra; QUERY: 1, ANSWER: 2, AUTHORITY: 1, ADDITIONAL: 1

;; QUESTION SECTION:
;www.zhengzhou.magedu.com.	IN	A

;; ANSWER SECTION:
www.zhengzhou.magedu.com. 86400	IN	CNAME	websrv.zhengzhou.magedu.com.
websrv.zhengzhou.magedu.com. 86400 IN	A	192.168.0.113

;; AUTHORITY SECTION:
zhengzhou.magedu.com.	86400	IN	NS	ns1.zhengzhou.magedu.com.

;; ADDITIONAL SECTION:
ns1.zhengzhou.magedu.com. 86400	IN	A	192.168.0.113

;; Query time: 1 msec
;; SERVER: 192.168.0.111#53(192.168.0.111)
;; WHEN: Wed Nov  4 20:20:55 2020
;; MSG SIZE  rcvd: 113

```

### 8.2.1 TCP53端口作用

```
[root@node1 named]# iptables -A INPUT -p tcp --dport 53 -j REJECT
[root@node1 named]# vim /var/named/magedu.com.zone 
加入
test7                         A          7.1.1.1
[root@node1 named]# systemctl restart named
会阻止同步、客户端也不能访问主的dns服务器


```

### 8.2.2 客户端测试

```
[root@node5 ~]# dig -t a test7.magedu.com @192.168.112

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> -t a test7.magedu.com @192.168.112
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 54952
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 2, ADDITIONAL: 2

;; QUESTION SECTION:
;test7.magedu.com.		IN	A

;; ANSWER SECTION:
test7.magedu.com.	86400	IN	A	192.168.0.116

;; AUTHORITY SECTION:
magedu.com.		86400	IN	NS	ns2.magedu.com.
magedu.com.		86400	IN	NS	ns1.magedu.com.

;; ADDITIONAL SECTION:
ns1.magedu.com.		86400	IN	A	192.168.0.111
ns2.magedu.com.		86400	IN	A	192.168.0.112

;; Query time: 0 msec
;; SERVER: 192.168.0.112#53(192.168.0.112)
;; WHEN: Wed Nov  4 21:23:23 2020
;; MSG SIZE  rcvd: 118

```

### 8.2.3 UDP53端口设为拒绝

```
[root@node1 named]# iptables -A INPUT -p udp --dport 53 -j REJECT
[root@node1 named]# systemctl restart named

拒绝访问，但是可以同步给从服务器，可以从服务器访问

```

```
总结：tcp拒绝同步和访问、udp可以同步，不可以访问

```

## 8.3.1 开启rndc日志功能

```
[root@node1 named]# rndc querylog
[root@node1 named]# rndc status
version: BIND 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 (Extended Support Version) <id:7107deb>
running on node1: Linux x86_64 3.10.0-693.el7.x86_64 #1 SMP Tue Aug 22 21:09:27 UTC 2017
boot time: Thu, 05 Nov 2020 00:40:11 GMT
last configured: Thu, 05 Nov 2020 00:46:49 GMT
configuration file: /etc/named.conf
CPUs found: 1
worker threads: 1
UDP listeners per interface: 1
number of zones: 106 (97 automatic)
debug level: 0
xfers running: 0
xfers deferred: 0
soa queries in progress: 0
query logging is ON
recursive clients: 0/900/1000
tcp clients: 3/150
server is up and running
[root@node1 named]# 

```

```
[root@node1 named]# tail -f /var/log/messages 
Nov  4 19:59:29 node1 named[51983]: received control channel command 'query'
Nov  4 19:59:29 node1 named[51983]: unknown control channel command 'query'
Nov  4 19:59:39 node1 named[51983]: received control channel command 'querylog'
Nov  4 19:59:39 node1 named[51983]: query logging is now on
Nov  4 20:00:01 node1 systemd: Started Session 142 of user root.
Nov  4 20:00:01 node1 systemd: Starting Session 142 of user root.
Nov  4 20:01:01 node1 systemd: Started Session 143 of user root.
Nov  4 20:01:01 node1 systemd: Starting Session 143 of user root.
Nov  4 20:01:15 node1 named[51983]: client @0x7f34e80a9b30 192.168.0.6#57298 (test14.magedu.com): query: test14.magedu.com IN A + (192.168.0.111)
Nov  4 20:01:22 node1 named[51983]: client @0x7f34e80a9b30 192.168.0.6#44083 (test14.magedu.com): query: test14.magedu.com IN A + (192.168.0.111)

```

## 9.1.1 DNS转发

​       192.168.0.111      192.168.0.112     192.168.0.6

​                                          转发服务器      客户端   112 和6 不能连接外网

### 9.1.2 直缓存服务器安装

```
[root@node1 ~]# iptables -F
[root@node1 ~]# setenforce 0


[root@node1 ~]# yum -y install bind
//      listen-on port 53 { 127.0.0.1; };
//      allow-query     { localhost; };
 dnssec-enable no;
 dnssec-validation no;

[root@node1 ~]# systemctl restart named

```

### 9.1.3 转发服务器配置

```
[root@node2 ~]# iptables -F
[root@node2 ~]# setenforce 0
[root@node2 ~]# yum -y install bind
//      listen-on port 53 { 127.0.0.1; };
//      allow-query     { localhost; };
         forward   only;
         forwarders { 192.168.0.111; };
   dnssec-enable no;
        dnssec-validation no;
[root@node2 ~]# systemctl restart named
[root@node2 ~]# route del default gw 192.168.0.1
[root@node2 ~]# route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 ens33
192.168.122.0   0.0.0.0         255.255.255.0   U     0      0        0 virbr0
[root@node2 ~]# 
[root@node2 ~]# ping www.baidu.com
connect: Network is unreachable
[root@node2 ~]# 


```

### 9.1.4 客户端

```
[root@node5 ~]# iptables -F
[root@node5 ~]# setenforce 0
[root@node5 ~]# route del default gw 192.168.0.1
[root@node5 ~]# 
[root@node5 ~]# dig www.baidu.com @192.168.0.112

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> www.baidu.com @192.168.0.112
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 34172
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 5, ADDITIONAL: 5

;; QUESTION SECTION:
;www.baidu.com.			IN	A

;; ANSWER SECTION:
www.baidu.com.		1199	IN	CNAME	www.a.shifen.com.
www.a.shifen.com.	300	IN	A	39.156.66.14
www.a.shifen.com.	300	IN	A	39.156.66.18

;; AUTHORITY SECTION:
a.shifen.com.		1200	IN	NS	ns3.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns4.a.shifen.com.
a.shifen.com.		1200	IN	NS	ns2.a.shifen.com.

```

### 9.1.5 清空缓存停止服务器

```
[root@node1 ~]# rndc flush
[root@node1 ~]# 
[root@node1 ~]# 
[root@node1 ~]# systemctl stop named

```

```
[root@node2 ~]# rndc flush
[root@node2 ~]# 

```

```
[root@node5 ~]# dig www.baidu.com @192.168.0.112

; <<>> DiG 9.8.2rc1-RedHat-9.8.2-0.37.rc1.el6 <<>> www.baidu.com @192.168.0.112
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 30903
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0

;; QUESTION SECTION:
;www.baidu.com.			IN	A

;; Query time: 1 msec
;; SERVER: 192.168.0.112#53(192.168.0.112)
;; WHEN: Sun Nov  1 23:51:26 2020
;; MSG SIZE  rcvd: 31

[root@node5 ~]# 

```

